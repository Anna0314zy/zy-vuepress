---
title: umi æƒé™ç®¡ç†
tags:
   - umi
---

## 1. æƒé™ç³»ç»Ÿçš„å¸¸è§è®¾è®¡

åœ¨ä¼ä¸šé¡¹ç›®é‡Œï¼Œä¸€èˆ¬æƒé™ç³»ç»Ÿæ˜¯ **RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰**ï¼š

* **ç”¨æˆ·ï¼ˆUserï¼‰**ï¼šæŸä¸ªäººå‘˜
* **è§’è‰²ï¼ˆRoleï¼‰**ï¼šä¾‹å¦‚â€œç®¡ç†å‘˜â€ã€â€œè¿è¥äººå‘˜â€ã€â€œæ™®é€šç”¨æˆ·â€
* **æƒé™ï¼ˆPermissionï¼‰**ï¼š

  * **è·¯ç”±æƒé™**ï¼šèƒ½å¦è®¿é—®æŸä¸ªé¡µé¢ï¼Œä¾‹å¦‚ `/user/list`
  * **æ“ä½œæƒé™ï¼ˆæŒ‰é’®æƒé™ï¼‰**ï¼šèƒ½å¦ç‚¹å‡»æŸä¸ªæŒ‰é’®ï¼Œä¾‹å¦‚â€œæ–°å¢â€ã€â€œåˆ é™¤â€ã€â€œå¯¼å‡ºâ€

æ•°æ®åº“ä¸­å¸¸è§ç»“æ„ï¼š

```
ç”¨æˆ·è¡¨ user
  id, name, roleId

è§’è‰²è¡¨ role
  id, name

æƒé™è¡¨ permission
  id, type(èœå•/æŒ‰é’®), code(å”¯ä¸€æ ‡è¯†), path(èœå•å¯¹åº”è·¯ç”±)

è§’è‰²-æƒé™è¡¨ role_permission
  roleId, permissionId
```

---

## 2. æ•°æ®æµè½¬æµç¨‹

1. **ç”¨æˆ·ç™»å½•**

   * ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç ï¼Œåç«¯è¿”å› **ç”¨æˆ·ä¿¡æ¯ + è§’è‰² + æƒé™åˆ—è¡¨ï¼ˆèœå•/æŒ‰é’®ï¼‰+ token**ã€‚

   ```json
   {
     "token": "xxx",
     "userInfo": {
       "id": 1,
       "name": "å¼ ä¸‰",
       "role": "admin"
     },
     "permissions": [
       { "type": "route", "code": "user:list", "path": "/user/list" },
       { "type": "button", "code": "user:add" },
       { "type": "button", "code": "user:delete" }
     ]
   }
   ```

2. **å‰ç«¯ä¿å­˜æ•°æ®**

   * ä¸€èˆ¬ä¿å­˜åœ¨ Redux / Zustand / Valtio / Umi çš„ `initialState` é‡Œã€‚

3. **å‰ç«¯è·¯ç”±æ¸²æŸ“**

   * æ ¹æ®ç”¨æˆ·çš„æƒé™è¡¨ï¼Œè¿‡æ»¤æ‰æ²¡æœ‰æƒé™çš„è·¯ç”±ã€‚
   * å¯¹äºæŒ‰é’®ï¼Œå°è£…ä¸€ä¸ª `Access` ç»„ä»¶æ¥åšæƒé™æ ¡éªŒã€‚

---

## 3. åœ¨ Umi é‡Œçš„æƒé™ä½“ç³»

Umi æä¾›äº† `@umijs/plugin-access` æ’ä»¶ï¼Œå¸®ä½ æŠŠæƒé™é€»è¾‘å’Œè·¯ç”±/ç»„ä»¶ç»“åˆã€‚

### 3.1 é…ç½® access.ts

`src/access.ts` ç”¨æ¥æ ¹æ®ç”¨æˆ·ä¿¡æ¯ç”Ÿæˆæƒé™å‡½æ•°ï¼š

```ts
// src/access.ts
export default function access(initialState: { permissions?: string[] } | undefined) {
  const { permissions = [] } = initialState || {};

  return {
    // è·¯ç”±è®¿é—®æƒé™
    canUserList: permissions.includes('user:list'),
    canUserAdd: permissions.includes('user:add'),
    canUserDelete: permissions.includes('user:delete'),
  };
}
```

### 3.2 é…ç½®è·¯ç”±æƒé™

`config/routes.ts`

```ts
export default [
  {
    path: '/user/list',
    name: 'ç”¨æˆ·åˆ—è¡¨',
    component: '@/pages/UserList',
    access: 'canUserList', // ğŸ‘ˆ è·¯ç”±çº§åˆ«æƒé™æ§åˆ¶
  },
];
```

Umi ä¼šè‡ªåŠ¨æ‹¦æˆªæ²¡æœ‰æƒé™çš„è·¯ç”±ï¼Œè·³åˆ° `403` é¡µé¢ã€‚

### 3.3 æŒ‰é’®çº§åˆ«æƒé™

å†™ä¸€ä¸ªé€šç”¨çš„æƒé™ç»„ä»¶ï¼š

```tsx
// src/components/AccessBtn.tsx
import { useAccess } from 'umi';

export default ({ accessKey, children }: { accessKey: string; children: React.ReactNode }) => {
  const access = useAccess();
  if (!access[accessKey]) return null;
  return <>{children}</>;
};
```

é¡µé¢é‡Œä½¿ç”¨ï¼š

```tsx
import AccessBtn from '@/components/AccessBtn';

export default () => {
  return (
    <div>
      <AccessBtn accessKey="canUserAdd">
        <button>æ–°å¢ç”¨æˆ·</button>
      </AccessBtn>
      <AccessBtn accessKey="canUserDelete">
        <button>åˆ é™¤ç”¨æˆ·</button>
      </AccessBtn>
    </div>
  );
};
```

---

## 4. æ•°æ®æµè½¬çš„å®Œæ•´ä»£ç æµç¨‹

### 4.1 ç™»å½•æ¥å£

```ts
// src/services/auth.ts
import { request } from 'umi';

export async function login(params: { username: string; password: string }) {
  return request('/api/login', {
    method: 'POST',
    data: params,
  });
}
```

### 4.2 initialState è·å–ç”¨æˆ·æƒé™

```ts
// src/app.tsx
import { getUserInfo } from '@/services/user';

export async function getInitialState() {
  const userInfo = await getUserInfo(); // åç«¯è¿”å› { user, permissions }
  return userInfo;
}
```

### 4.3 access.ts ç”Ÿæˆæƒé™å‡½æ•°

```ts
// src/access.ts
export default function access(initialState: any) {
  const { permissions = [] } = initialState || {};
  return permissions.reduce((acc: any, p: string) => {
    acc[p] = true; // åŠ¨æ€ç”Ÿæˆ
    return acc;
  }, {});
}
```

è¿™æ ·å°±ä¸ç”¨å†™æ­»ï¼Œå¯ä»¥æ”¯æŒåŠ¨æ€çš„æƒé™ç‚¹ï¼ˆæŒ‰é’®/èœå•ï¼‰ã€‚

---

## 5. æ€»ç»“

* **åç«¯**ï¼šç»´æŠ¤ ç”¨æˆ·-è§’è‰²-æƒé™è¡¨ï¼Œè¿”å› `permissions[]` ç»™å‰ç«¯
* **å‰ç«¯**ï¼š

  * ç™»å½•æ—¶æ‹¿åˆ° `permissions`
  * å­˜åœ¨ `initialState`
  * `access.ts` è½¬æ¢æˆå¸ƒå°”æƒé™å‡½æ•°
  * è·¯ç”±é€šè¿‡ `access` å­—æ®µæ§åˆ¶
  * æŒ‰é’®é€šè¿‡ `AccessBtn` å°è£…ç»„ä»¶æ§åˆ¶
* **å¥½å¤„**ï¼šæ¸…æ™°ã€å¯ç»´æŠ¤ã€æ‰©å±•æ–¹ä¾¿

---


---
title: umi 权限管理
tags:
   - umi
---

## 1. 权限系统的常见设计

在企业项目里，一般权限系统是 **RBAC（基于角色的访问控制）**：

* **用户（User）**：某个人员
* **角色（Role）**：例如“管理员”、“运营人员”、“普通用户”
* **权限（Permission）**：

  * **路由权限**：能否访问某个页面，例如 `/user/list`
  * **操作权限（按钮权限）**：能否点击某个按钮，例如“新增”、“删除”、“导出”

数据库中常见结构：

```
用户表 user
  id, name, roleId

角色表 role
  id, name

权限表 permission
  id, type(菜单/按钮), code(唯一标识), path(菜单对应路由)

角色-权限表 role_permission
  roleId, permissionId
```

---

## 2. 数据流转流程

1. **用户登录**

   * 用户输入账号密码，后端返回 **用户信息 + 角色 + 权限列表（菜单/按钮）+ token**。

   ```json
   {
     "token": "xxx",
     "userInfo": {
       "id": 1,
       "name": "张三",
       "role": "admin"
     },
     "permissions": [
       { "type": "route", "code": "user:list", "path": "/user/list" },
       { "type": "button", "code": "user:add" },
       { "type": "button", "code": "user:delete" }
     ]
   }
   ```

2. **前端保存数据**

   * 一般保存在 Redux / Zustand / Valtio / Umi 的 `initialState` 里。

3. **前端路由渲染**

   * 根据用户的权限表，过滤掉没有权限的路由。
   * 对于按钮，封装一个 `Access` 组件来做权限校验。

---

## 3. 在 Umi 里的权限体系

Umi 提供了 `@umijs/plugin-access` 插件，帮你把权限逻辑和路由/组件结合。

### 3.1 配置 access.ts

`src/access.ts` 用来根据用户信息生成权限函数：

```ts
// src/access.ts
export default function access(initialState: { permissions?: string[] } | undefined) {
  const { permissions = [] } = initialState || {};

  return {
    // 路由访问权限
    canUserList: permissions.includes('user:list'),
    canUserAdd: permissions.includes('user:add'),
    canUserDelete: permissions.includes('user:delete'),
  };
}
```

### 3.2 配置路由权限

`config/routes.ts`

```ts
export default [
  {
    path: '/user/list',
    name: '用户列表',
    component: '@/pages/UserList',
    access: 'canUserList', // 👈 路由级别权限控制
  },
];
```

Umi 会自动拦截没有权限的路由，跳到 `403` 页面。

### 3.3 按钮级别权限

写一个通用的权限组件：

```tsx
// src/components/AccessBtn.tsx
import { useAccess } from 'umi';

export default ({ accessKey, children }: { accessKey: string; children: React.ReactNode }) => {
  const access = useAccess();
  if (!access[accessKey]) return null;
  return <>{children}</>;
};
```

页面里使用：

```tsx
import AccessBtn from '@/components/AccessBtn';

export default () => {
  return (
    <div>
      <AccessBtn accessKey="canUserAdd">
        <button>新增用户</button>
      </AccessBtn>
      <AccessBtn accessKey="canUserDelete">
        <button>删除用户</button>
      </AccessBtn>
    </div>
  );
};
```

---

## 4. 数据流转的完整代码流程

### 4.1 登录接口

```ts
// src/services/auth.ts
import { request } from 'umi';

export async function login(params: { username: string; password: string }) {
  return request('/api/login', {
    method: 'POST',
    data: params,
  });
}
```

### 4.2 initialState 获取用户权限

```ts
// src/app.tsx
import { getUserInfo } from '@/services/user';

export async function getInitialState() {
  const userInfo = await getUserInfo(); // 后端返回 { user, permissions }
  return userInfo;
}
```

### 4.3 access.ts 生成权限函数

```ts
// src/access.ts
export default function access(initialState: any) {
  const { permissions = [] } = initialState || {};
  return permissions.reduce((acc: any, p: string) => {
    acc[p] = true; // 动态生成
    return acc;
  }, {});
}
```

这样就不用写死，可以支持动态的权限点（按钮/菜单）。

---

## 5. 总结

* **后端**：维护 用户-角色-权限表，返回 `permissions[]` 给前端
* **前端**：

  * 登录时拿到 `permissions`
  * 存在 `initialState`
  * `access.ts` 转换成布尔权限函数
  * 路由通过 `access` 字段控制
  * 按钮通过 `AccessBtn` 封装组件控制
* **好处**：清晰、可维护、扩展方便

---


---
title: æ—¶é—´æ—…è¡Œ
tags:
   - react
---


React çš„â€œæ—¶é—´æ—…è¡Œï¼ˆTime Travelï¼‰â€æ˜¯æŒ‡åœ¨åº”ç”¨çš„å¼€å‘æˆ–è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œ**èƒ½å¤Ÿè¿½è¸ªå¹¶å›é€€åº”ç”¨çŠ¶æ€åˆ°å…ˆå‰çš„æŸä¸€ä¸ªç‚¹**ï¼Œå°±åƒå¯ä»¥åœ¨æ—¶é—´è½´ä¸Šâ€œæ—…è¡Œâ€ä¸€æ ·ã€‚

è¿™ä¸ªæ¦‚å¿µçš„æ ¸å¿ƒåœ¨äºï¼š

> **å°†åº”ç”¨çš„çŠ¶æ€å˜åŒ–çœ‹ä½œä¸€ç³»åˆ—å¯ä»¥å›æ”¾çš„å†å²è®°å½•ï¼Œä»è€Œå¯ä»¥éšæ—¶è·³è½¬åˆ°ä»»æ„ä¸€ä¸ªçŠ¶æ€ã€‚**

---

## ğŸ§  èƒŒåçš„æ€æƒ³

React æœ¬èº«æ˜¯ä¸€ä¸ª UI åº“ï¼Œå¹¶ä¸å…·å¤‡æ—¶é—´æ—…è¡Œçš„èƒ½åŠ›ã€‚ä½†ç»“åˆ **çŠ¶æ€ç®¡ç†å·¥å…·**ï¼ˆå¦‚ Reduxï¼‰åï¼Œå¯ä»¥åšåˆ°çŠ¶æ€çš„å¯é¢„æµ‹æ€§å’Œå†å²è®°å½•çš„ä¿å­˜ï¼Œä»è€Œå®ç°æ—¶é—´æ—…è¡Œè°ƒè¯•ã€‚

---

## â³ ä¸¾ä¸ªä¾‹å­

å‡è®¾ä½ æœ‰ä¸€ä¸ª Redux ç®¡ç†çš„è®¡æ•°å™¨ï¼š

```ts
{
  count: 0
}
```

æ¯æ¬¡ç‚¹å‡»æŒ‰é’®ï¼Œ`count` å¢åŠ  1ã€‚çŠ¶æ€ä¼šä¾æ¬¡å˜ä¸ºï¼š

```
0 â†’ 1 â†’ 2 â†’ 3
```

å¦‚æœä½ è®°å½•äº†æ¯ä¸€ä¸ªçŠ¶æ€ï¼Œå°±å¯ä»¥ï¼š

* å›é€€åˆ° `count = 1` çš„çŠ¶æ€
* å‰è¿›åˆ° `count = 3`
* é‡æ”¾æ•´ä¸ªçŠ¶æ€å˜åŒ–è¿‡ç¨‹

è¿™å°±æ˜¯æ—¶é—´æ—…è¡Œè°ƒè¯•ã€‚

---

## âš™ï¸ å®ç°æ–¹å¼ï¼ˆä»¥ Redux ä¸ºä¾‹ï¼‰

1. **è®°å½•æ¯ä¸€æ¬¡ dispatch åçš„ state**
2. ä¿å­˜è¿™äº› state åˆ°ä¸€ä¸ª history æ•°ç»„ä¸­
3. æä¾›å‰è¿› / åé€€çš„æ–¹æ³•ï¼ˆå¦‚ `undo`, `redo`ï¼‰
4. ç”¨æŸä¸ª UI æ§ä»¶ï¼ˆå¦‚ DevToolsï¼‰æ¥æ“ä½œçŠ¶æ€å†å²

ä¾‹å¦‚ï¼š

```ts
const history = [
  { count: 0 },
  { count: 1 },
  { count: 2 },
  { count: 3 }
];
```

å½“ä½ ç‚¹å‡» Redux DevTools ä¸Šçš„â€œè·³è½¬åˆ°ç¬¬ 2 æ­¥â€ï¼Œå°±å¯ä»¥è®© UI è‡ªåŠ¨å›åˆ° `count = 2` çš„ç•Œé¢ã€‚

---

## ğŸš€ æ—¶é—´æ—…è¡Œçš„æ„ä¹‰

* **è°ƒè¯•å˜å¾—ç®€å•**ï¼šå¯è§†åŒ–æ¯ä¸€æ­¥çŠ¶æ€å˜åŒ–ï¼Œæ’æŸ¥ bug å¦‚åŒâ€œå€’å¸¦è§†é¢‘â€
* **çŠ¶æ€å¯è¿½æº¯**ï¼šçŸ¥é“æ¯æ¬¡ UI æ›´æ–°æ˜¯ç”±ä»€ä¹ˆ action è§¦å‘çš„
* **å¼€å‘ä½“éªŒæå‡**ï¼šè‡ªåŠ¨çƒ­é‡è½½ + æ—¶é—´æ—…è¡Œï¼Œè®©å‰ç«¯å¼€å‘ä½“éªŒåª²ç¾åç«¯æ–­ç‚¹è°ƒè¯•

---

## ğŸ§© å°ç»“

| ç‰¹æ€§ | æè¿°                  |
| -- | ------------------- |
| æœ¬è´¨ | çŠ¶æ€çš„å†å²è®°å½•ä¸è·³è½¬          |
| åº”ç”¨ | Redux DevToolsã€çŠ¶æ€è°ƒè¯• |
| ä¼˜åŠ¿ | å¯å›æ”¾ã€è°ƒè¯•æ–¹ä¾¿            |
| è¦æ±‚ | çŠ¶æ€æ˜¯å¯é¢„æµ‹ã€å¯åºåˆ—åŒ–çš„ï¼ˆPureï¼‰  |

---
æ’¤é”€ / é‡åšç³»ç»Ÿï¼ˆUndo / Redo Systemï¼‰æ˜¯äº¤äº’å¼åº”ç”¨ï¼ˆå¦‚ç¼–è¾‘å™¨ã€ç»˜å›¾å·¥å…·ã€è¡¨å•ã€IDE ç­‰ï¼‰ä¸­éå¸¸å…³é”®çš„ä¸€ç§ç”¨æˆ·ä½“éªŒæœºåˆ¶ï¼Œç”¨äº **æ¢å¤ä¹‹å‰çŠ¶æ€æˆ–é‡æ–°åº”ç”¨è¢«æ’¤é”€çš„æ“ä½œ**ã€‚å®ƒè®©ç”¨æˆ·åœ¨æ“ä½œè¿‡ç¨‹ä¸­æ‹¥æœ‰æ›´å¤šæŒæ§æƒï¼Œä¸å¿…æ‹…å¿ƒæ“ä½œå¤±è¯¯æ— æ³•å›é€€ã€‚

---

## ä¸€ã€æ¦‚å¿µç†è§£

### âœ… æ’¤é”€ï¼ˆUndoï¼‰ï¼š

> å°†ç³»ç»ŸçŠ¶æ€è¿˜åŸåˆ°ä¸Šä¸€æ­¥çš„çŠ¶æ€ã€‚

### âœ… é‡åšï¼ˆRedoï¼‰ï¼š

> åœ¨æ‰§è¡Œæ’¤é”€æ“ä½œä¹‹åï¼Œå¯ä»¥å†é‡æ–°æ‰§è¡Œè¢«æ’¤é”€çš„æ“ä½œã€‚

---

## äºŒã€åŸºæœ¬åŸç†

æ’¤é”€/é‡åšç³»ç»Ÿæœ¬è´¨ä¸Šæ˜¯ä¸€ç§ **â€œå‘½ä»¤å†å²ç®¡ç†â€**ï¼š

* æ¯æ¬¡ç”¨æˆ·æ‰§è¡Œä¸€ä¸ªæ“ä½œï¼Œå°±æŠŠè¯¥æ“ä½œå°è£…æˆä¸€ä¸ªå¯¹è±¡ï¼ˆCommandï¼‰
* æ“ä½œè¢«è®°å½•åœ¨ä¸€ä¸ª **æ’¤é”€æ ˆï¼ˆUndo Stackï¼‰**
* å½“ç”¨æˆ·ç‚¹å‡»â€œæ’¤é”€â€æ—¶ï¼Œä»æ’¤é”€æ ˆä¸­å¼¹å‡ºæœ€è¿‘çš„å‘½ä»¤ï¼Œå¹¶æ‰§è¡Œå…¶ `undo()` æ–¹æ³•
* è¢«æ’¤é”€çš„å‘½ä»¤ä¼šå‹å…¥ **é‡åšæ ˆï¼ˆRedo Stackï¼‰**
* è‹¥ç”¨æˆ·ç‚¹å‡»â€œé‡åšâ€ï¼Œä»é‡åšæ ˆä¸­å–å‡ºå‘½ä»¤ï¼Œè°ƒç”¨ `execute()`ï¼Œå†å‹å›æ’¤é”€æ ˆ

å¦‚ä¸‹å›¾è¡¨ç¤ºï¼š

```
æ‰§è¡Œæ“ä½œï¼šA â†’ B â†’ C

æ’¤é”€ä¸¤æ­¥ï¼šæ’¤é”€ C â†’ æ’¤é”€ B

é‡åšä¸€æ­¥ï¼šé‡åš Bï¼ˆæ‰§è¡Œ B å†æ¬¡ï¼‰
```


## ç®€å•å®ç°
# åœ¨ Rematch ä¸­å®ç°å‘½ä»¤æ¨¡å¼æ’¤é”€/é‡åšåŠŸèƒ½

é’ˆå¯¹ä½ å½“å‰ä½¿ç”¨ Rematch ç®¡ç†çŠ¶æ€çš„æƒ…å†µï¼Œæˆ‘å°†æä¾›å‡ ç§æ”¹è¿›æ–¹æ¡ˆæ¥å®ç°æ’¤é”€/é‡åšåŠŸèƒ½ï¼ŒåŒæ—¶ä¿æŒä¸ Rematch çš„é›†æˆã€‚

## æ–¹æ¡ˆä¸€ï¼šåŸºäº Rematch + å‘½ä»¤æ¨¡å¼çš„é›†æˆæ–¹æ¡ˆ

### 1. åˆ›å»ºå‘½ä»¤å†å²æ¨¡å‹

```typescript
// models/history.model.ts
import { Dispatch } from "@rematch/core";

interface Command {
  execute(dispatch: Dispatch): void;
  undo(dispatch: Dispatch): void;
}

export interface HistoryModel {
  state: {
    undoStack: Command[];
    redoStack: Command[];
  };
  reducers: {
    executeCommand(state: HistoryModel["state"], command: Command): HistoryModel["state"];
    undo(state: HistoryModel["state"]): HistoryModel["state"];
    redo(state: HistoryModel["state"]): HistoryModel["state"];
  };
}

export const history: HistoryModel = {
  state: {
    undoStack: [],
    redoStack: [],
  },
  reducers: {
    executeCommand(state, command) {
      return {
        undoStack: [...state.undoStack, command],
        redoStack: [], // æ‰§è¡Œæ–°å‘½ä»¤æ—¶æ¸…ç©ºé‡åšæ ˆ
      };
    },
    undo(state) {
      if (state.undoStack.length === 0) return state;
      const command = state.undoStack[state.undoStack.length - 1];
      return {
        undoStack: state.undoStack.slice(0, -1),
        redoStack: [...state.redoStack, command],
      };
    },
    redo(state) {
      if (state.redoStack.length === 0) return state;
      const command = state.redoStack[state.redoStack.length - 1];
      return {
        undoStack: [...state.undoStack, command],
        redoStack: state.redoStack.slice(0, -1),
      };
    },
  },
};
```

### 2. åˆ›å»ºä¸šåŠ¡æ¨¡å‹ä¸å‘½ä»¤

```typescript
// models/todos.model.ts
import { Dispatch } from "@rematch/core";
import { Command } from "./history.model";

export interface Todo {
  id: string;
  text: string;
  completed: boolean;
}

export interface TodosModel {
  state: Todo[];
  reducers: {
    add(state: Todo[], payload: Todo): Todo[];
    toggle(state: Todo[], id: string): Todo[];
    updateState(state: Todo[], payload: Todo[]): Todo[];
  };
}

export const todos: TodosModel = {
  state: [],
  reducers: {
    add(state, payload) {
      return [...state, payload];
    },
    toggle(state, id) {
      return state.map(todo =>
        todo.id === id ? { ...todo, completed: !todo.completed } : todo
      );
    },
    updateState(_, payload) {
      return payload;
    },
  },
};

// åˆ›å»ºå…·ä½“çš„å‘½ä»¤ç±»
export class AddTodoCommand implements Command {
  constructor(
    private dispatch: Dispatch,
    private todo: Todo
  ) {}

  execute() {
    this.dispatch.todos.add(this.todo);
  }

  undo() {
    this.dispatch.todos.updateState(
      this.dispatch.todos.getState().filter(t => t.id !== this.todo.id)
    );
  }
}

export class ToggleTodoCommand implements Command {
  constructor(
    private dispatch: Dispatch,
    private id: string
  ) {}

  execute() {
    this.dispatch.todos.toggle(this.id);
  }

  undo() {
    this.dispatch.todos.toggle(this.id); // åˆ‡æ¢ä¸¤æ¬¡ç­‰äºæ’¤é”€
  }
}
```

### 3. é…ç½® Rematch Store

```typescript
// store.ts
import { init, RematchDispatch, RematchRootState } from "@rematch/core";
import { history } from "./models/history.model";
import { todos, Todo } from "./models/todos.model";

const store = init({
  models: {
    history,
    todos,
  },
});

export type Dispatch = RematchDispatch<typeof models>;
export type RootState = RematchRootState<typeof models>;
export default store;
```

### 4. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

```tsx
import React, { useState } from "react";
import { useDispatch, useSelector } from "react-redux";
import { Dispatch, RootState } from "./store";
import { AddTodoCommand, ToggleTodoCommand } from "./models/todos.model";

const TodoApp = () => {
  const dispatch = useDispatch<Dispatch>();
  const todos = useSelector((state: RootState) => state.todos);
  const history = useSelector((state: RootState) => state.history);
  const [text, setText] = useState("");

  const handleAdd = () => {
    const newTodo = {
      id: Date.now().toString(),
      text,
      completed: false,
    };
    const command = new AddTodoCommand(dispatch, newTodo);
    command.execute();
    dispatch.history.executeCommand(command);
    setText("");
  };

  const handleToggle = (id: string) => {
    const command = new ToggleTodoCommand(dispatch, id);
    command.execute();
    dispatch.history.executeCommand(command);
  };

  const handleUndo = () => {
    if (history.undoStack.length === 0) return;
    const command = history.undoStack[history.undoStack.length - 1];
    command.undo();
    dispatch.history.undo();
  };

  const handleRedo = () => {
    if (history.redoStack.length === 0) return;
    const command = history.redoStack[history.redoStack.length - 1];
    command.execute();
    dispatch.history.redo();
  };

  return (
    <div>
      <h1>Todo List with Undo/Redo</h1>
      <div>
        <input
          value={text}
          onChange={(e) => setText(e.target.value)}
          placeholder="New todo"
        />
        <button onClick={handleAdd}>Add</button>
      </div>
      <div>
        <button onClick={handleUndo} disabled={history.undoStack.length === 0}>
          Undo
        </button>
        <button onClick={handleRedo} disabled={history.redoStack.length === 0}>
          Redo
        </button>
      </div>
      <ul>
        {todos.map((todo) => (
          <li
            key={todo.id}
            onClick={() => handleToggle(todo.id)}
            style={{ textDecoration: todo.completed ? "line-through" : "none" }}
          >
            {todo.text}
          </li>
        ))}
      </ul>
      <div>
        <h3>History</h3>
        <p>Undo stack: {history.undoStack.length}</p>
        <p>Redo stack: {history.redoStack.length}</p>
      </div>
    </div>
  );
};

export default TodoApp;
```

## æ–¹æ¡ˆäºŒï¼šç»“åˆ Redux Undo çš„ç®€åŒ–æ–¹æ¡ˆ

å¦‚æœä½ ä¸éœ€è¦å®Œæ•´çš„å‘½ä»¤æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨æ›´ç®€å•çš„ Redux Undo é›†æˆï¼š

```typescript
// store.ts
import { init } from "@rematch/core";
import undoable from "redux-undo";

const todos = {
  state: [],
  reducers: {
    add(state, payload) {
      return [...state, payload];
    },
    toggle(state, id) {
      return state.map(todo =>
        todo.id === id ? { ...todo, completed: !todo.completed } : todo
      );
    },
    // å¿…é¡»æ·»åŠ è¿™ä¸ªreduceræ¥å¤„ç†å†å²çŠ¶æ€æ›´æ–°
    updateState(_, payload) {
      return payload;
    },
  },
};

const store = init({
  models: {
    todos: undoable(todos, {
      limit: 10,
      undoType: "todos/UNDO",
      redoType: "todos/REDO",
      clearHistoryType: "todos/CLEAR_HISTORY",
      filter: (action, currentState, previousState) => {
        // è¿‡æ»¤ä¸éœ€è¦è®°å½•å†å²çš„action
        return !action.type.startsWith("todos/updateState");
      },
    }),
  },
});

export default store;
```

## ä¸¤ç§æ–¹æ¡ˆçš„å¯¹æ¯”

| ç‰¹æ€§               | å‘½ä»¤æ¨¡å¼æ–¹æ¡ˆ                          | Redux Undo æ–¹æ¡ˆ               |
|--------------------|-------------------------------------|-------------------------------|
| å®ç°å¤æ‚åº¦         | è¾ƒé«˜                                | è¾ƒä½                          |
| çµæ´»æ€§             | é«˜ï¼Œå¯ä»¥è‡ªå®šä¹‰æ¯ä¸ªå‘½ä»¤çš„è¡Œä¸º         | ä¸­ï¼ŒåŸºäºçŠ¶æ€å¿«ç…§              |
| ä¸ Rematch é›†æˆåº¦  | éœ€è¦é¢å¤–ç®¡ç†å‘½ä»¤å†å²                 | ç›´æ¥é›†æˆ                      |
| é€‚ç”¨åœºæ™¯           | éœ€è¦ç²¾ç¡®æ§åˆ¶æ’¤é”€/é‡åšè¡Œä¸ºçš„å¤æ‚åœºæ™¯  | ç®€å•çš„æ’¤é”€/é‡åšéœ€æ±‚           |
| å†…å­˜ä½¿ç”¨           | è¾ƒé«˜ï¼Œå­˜å‚¨å‘½ä»¤å¯¹è±¡                   | ä¸­ç­‰ï¼Œå­˜å‚¨çŠ¶æ€å¿«ç…§            |
| å†å²è®°å½•å¯è¯»æ€§     | å¥½ï¼Œå‘½ä»¤æœ‰æ˜ç¡®è¯­ä¹‰                   | ä¸€èˆ¬ï¼Œåªæœ‰çŠ¶æ€å·®å¼‚            |

## æœ€ä½³å®è·µå»ºè®®

1. **ç®€å•åº”ç”¨**ï¼šä½¿ç”¨ Redux Undo æ–¹æ¡ˆï¼Œå¿«é€Ÿå®ç°åŸºæœ¬æ’¤é”€/é‡åšåŠŸèƒ½
2. **å¤æ‚åº”ç”¨**ï¼šé‡‡ç”¨å‘½ä»¤æ¨¡å¼æ–¹æ¡ˆï¼Œè·å¾—æ›´ç²¾ç¡®çš„æ§åˆ¶èƒ½åŠ›
3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - é™åˆ¶å†å²è®°å½•æ•°é‡
   - å¯¹äºå¤§å‹çŠ¶æ€ï¼Œè€ƒè™‘åªè®°å½•çŠ¶æ€å·®å¼‚è€Œéå®Œæ•´çŠ¶æ€
   - ä½¿ç”¨ä¸å¯å˜æ•°æ®æé«˜æ€§èƒ½
4. **ç”¨æˆ·ä½“éªŒ**ï¼š
   - æä¾›æ¸…æ™°çš„å¯è§†åŒ–å†å²è®°å½•
   - ç¦ç”¨ä¸å¯ç”¨çš„æ’¤é”€/é‡åšæŒ‰é’®
   - è€ƒè™‘æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ

## æ‰©å±•åŠŸèƒ½å®ç°

### 1. å†å²è®°å½•é¢„è§ˆ

```tsx
function HistoryPreview() {
  const history = useSelector((state: RootState) => state.history);
  
  return (
    <div>
      <h3>History Preview</h3>
      <div>
        {history.undoStack.map((command, index) => (
          <div key={index}>
            <button onClick={() => jumpToCommand(index)}>
              {command.constructor.name} at step {index}
            </button>
          </div>
        ))}
      </div>
    </div>
  );
}
```

### 2. ä¸€é”®è·³è½¬åˆ°ç‰¹å®šå†å²æ­¥éª¤

```typescript
// åœ¨ history.model.ts ä¸­æ·»åŠ 
reducers: {
  jumpTo(state, payload: number) {
    if (payload < 0 || payload >= state.undoStack.length) return state;
    
    const commandsToUndo = state.undoStack.slice(payload);
    const newUndoStack = state.undoStack.slice(0, payload);
    const newRedoStack = [...commandsToUndo.reverse(), ...state.redoStack];
    
    return {
      undoStack: newUndoStack,
      redoStack: newRedoStack,
    };
  },
}
```

### 3. æ·»åŠ æ—¶é—´æˆ³å’Œæè¿°

```typescript
interface TimestampedCommand extends Command {
  timestamp: number;
  description: string;
}

class AddTodoCommand implements TimestampedCommand {
  timestamp = Date.now();
  
  get description() {
    return `Add todo: ${this.todo.text}`;
  }
  
  // ...åŸæœ‰å®ç°
}
```

## æ€»ç»“

åœ¨ Rematch ä¸­å®ç°æ’¤é”€/é‡åšåŠŸèƒ½çš„å…³é”®ç‚¹ï¼š

1. **æ˜ç¡®éœ€æ±‚**ï¼šæ ¹æ®åº”ç”¨å¤æ‚åº¦é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆ
2. **ä¿æŒçŠ¶æ€ä¸å¯å˜**ï¼šè¿™æ˜¯æ’¤é”€/é‡åšåŠŸèƒ½çš„åŸºç¡€
3. **åˆç†è®¾è®¡å‘½ä»¤**ï¼šæ¯ä¸ªå‘½ä»¤åº”è¯¥å°è£…å®Œæ•´çš„æ‰§è¡Œå’Œæ’¤é”€é€»è¾‘
4. **æ€§èƒ½è€ƒè™‘**ï¼šé™åˆ¶å†å²è®°å½•æ•°é‡ï¼Œé¿å…å†…å­˜é—®é¢˜
5. **è‰¯å¥½ç”¨æˆ·ä½“éªŒ**ï¼šæä¾›æ¸…æ™°çš„å†å²è®°å½•å±•ç¤ºå’Œæ“ä½œåé¦ˆ

é€šè¿‡ä»¥ä¸Šæ–¹æ¡ˆï¼Œä½ å¯ä»¥åœ¨ä¿æŒ Rematch çŠ¶æ€ç®¡ç†çš„åŒæ—¶ï¼Œå®ç°å¼ºå¤§çš„æ’¤é”€/é‡åšåŠŸèƒ½ã€‚

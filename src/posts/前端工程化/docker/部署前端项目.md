---
title: 部署前端项目
tags:
  - docker
---

## **1️⃣ 流程概览**

1. **开发者 push 代码到 GitHub**

   * `develop` 分支 → 测试环境
   * `main` 分支 → 生产环境

2. **GitHub Actions 监听对应分支**

   * 自动触发 CI 流程

3. **执行前端构建**

   * `pnpm build --mode dev` → 测试环境
   * `pnpm build --mode prod` → 生产环境

4. **构建 Docker 镜像**

   * 将对应构建好的 `dist`（或 `build`）放入 Nginx 容器

5. **推送镜像到镜像仓库**

   * Docker Hub / GitHub Packages / 私有仓库

6. **服务器拉取最新镜像 & 更新容器**

   * SSH 连接到服务器
   * 拉取最新镜像、启动新容器、停止旧容器
   * 实现 **零停机更新**

整个过程 **全自动**，不需要人工干预。

---

## **2️⃣ GitHub Actions 配置分支监听**

`.github/workflows/deploy.yml` 示例：

```yaml
name: Build and Deploy Frontend

on:
  push:
    branches:
      - main
      - develop

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '9.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Set Environment Variables
        run: |
          if [ "${GITHUB_REF}" == "refs/heads/main" ]; then
            TAG=prod
            BUILD_ENV=production
          else
            TAG=test
            BUILD_ENV=development
          fi

          DOCKER_IMAGE=react-demo
          VERSION=$(jq -r '.version' package.json)
          DOCKER_TAG="$TAG-$VERSION"

          # 写入 GitHub Actions 环境变量
          echo "BUILD_ENV=$BUILD_ENV" >> $GITHUB_ENV
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "DOCKER_IMAGE=$DOCKER_IMAGE" >> $GITHUB_ENV
          echo "DOCKER_TAG=$DOCKER_TAG" >> $GITHUB_ENV

      - name: Build and Push Docker Image
        run: |
          echo "Building Docker image  ${{ vars.DOCKER_USERNAME }}/$DOCKER_IMAGE:$DOCKER_TAG"
          docker build --build-arg BUILD_ENV=$BUILD_ENV \
            -t  ${{ vars.DOCKER_USERNAME }}/$DOCKER_IMAGE:$DOCKER_TAG .
          docker push  ${{ vars.DOCKER_USERNAME }}/$DOCKER_IMAGE:$DOCKER_TAG


      # SSH 到服务器部署
```

---

## **3️⃣ 关键点解析**

1. **监听分支**

```yaml
on:
  push:
    branches:
      - main
      - develop
```

* GitHub Actions 会在对应分支有 push 自动触发。

2. **构建不同环境**

```bash
pnpm build --mode prod   # 生产
pnpm build --mode dev    # 测试/预发
```

* `--mode` 决定前端环境变量，例如 API 地址等。

3. **Docker 镜像打包**

* 构建完成后，把 `dist/` 放进 Nginx 镜像
* 用 **镜像 TAG** 区分环境（prod/staging）

4. **通知 Nginx / 部署**

* 通过 SSH 在服务器执行：

  * `docker pull` 拉最新镜像
  * `docker run` 启动临时容器
  * 停掉旧容器、rename 临时容器 → 零停机更新

---

✅ **优点**

* **自动化**：push 代码 → 自动构建 → 自动部署
* **多环境**：通过分支区分测试/生产
* **零停机**：部署过程中服务不断线
* **可扩展**：可加预发、灰度发布等

---

`push 分支 → Actions 构建 → Docker 镜像 → 服务器零停机部署 → Nginx 服务上线`


## github action

GitHubActions [https://juejin.cn/post/7213911755067310137]
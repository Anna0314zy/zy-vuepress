---
title: Vue3 æ•°æ®ç»‘å®šåŸç†
tags:
  - vue3
---
```markdown
# Vue 3 å“åº”å¼ç³»ç»ŸåŸç†ç¤ºä¾‹è§£æ

## å“åº”å¼æ•°æ® reactive       
- é€šè¿‡ Proxy å®ç°æ•°æ®åŠ«æŒ
- ä¾èµ–æ”¶é›†ï¼ˆtrackï¼‰ä¸è§¦å‘æ›´æ–°ï¼ˆtriggerï¼‰
- å‰¯ä½œç”¨å‡½æ•°ï¼ˆeffectï¼‰ç®¡ç†
- æ¡ä»¶åˆ†æ”¯çš„ä¾èµ–åˆ‡æ¢


æµ‹è¯• 
```js
const state  = reactive({
            ok:true,
            name: 'vue',
            age: 1,
            address: {
                city: 'shanghai'
            }
        })

        const name = toRef(state.name)
        // TODO å¯¹è±¡è¢«å¤šæ¬¡ä»£ç†
        const state1 = reactive(state)
        const state2 = reactive(state)
        console.log("å¯¹è±¡è¢«å¤šæ¬¡ä»£ç†",state1 === state2) // true
        // // TODO ä»£ç†è¢«ä»£ç†çš„å¯¹è±¡
        const state3 = reactive(state1)
        console.log("ä»£ç†è¢«ä»£ç†çš„å¯¹è±¡",state3,state1 === state3) // true
```


```ts
const reactiveMap = new WeakMap(); // weakmap å¼±å¼•ç”¨   keyå¿…é¡»æ˜¯å¯¹è±¡ï¼Œå¦‚æœkeyæ²¡æœ‰è¢«å¼•ç”¨å¯ä»¥è¢«è‡ªåŠ¨é”€æ¯

function createReactiveObject(target: object) { 
    // å…ˆé»˜è®¤è®¤ä¸ºè¿™ä¸ªtargetå·²ç»æ˜¯ä»£ç†è¿‡çš„å±æ€§äº†
    if ((target as any)[ReactiveFlags.IS_REACTIVE]) {
        return target
    }
    // reactiveApi åªé’ˆå¯¹å¯¹è±¡æ‰å¯ä»¥ 
    if (!isObject(target)) {
        return target
    }
    const exisitingProxy = reactiveMap.get(target); // å¦‚æœç¼“å­˜ä¸­æœ‰ ç›´æ¥ä½¿ç”¨ä¸Šæ¬¡ä»£ç†çš„ç»“æœ
    if (exisitingProxy) {
        return exisitingProxy
    }
    const proxy = new Proxy(target, mutableHandlers); // å½“ç”¨æˆ·è·å–å±æ€§ æˆ–è€…æ›´æ”¹å±æ€§çš„æ—¶å€™ æˆ‘èƒ½åŠ«æŒåˆ°
    reactiveMap.set(target, proxy); // å°†åŸå¯¹è±¡å’Œç”Ÿæˆçš„ä»£ç†å¯¹è±¡ åšä¸€ä¸ªæ˜ å°„è¡¨

    return proxy; // è¿”å›ä»£ç†
}

export function reactive(target: object) {
    return createReactiveObject(target)
}

```

```ts

const mutableHandlers: ProxyHandler<Record<any, any>> = {
    get(target, key, recevier) { // ä»£ç†å¯¹è±¡çš„æœ¬èº«
        if (key === ReactiveFlags.IS_REACTIVE) {
            return true;
        }
        track(target,key);
        // è¿™é‡Œå–å€¼äº†ï¼Œ å¯ä»¥æ”¶é›†ä»–åœ¨å“ªä¸ªeffectä¸­
        const res = Reflect.get(target, key, recevier); // target[key]
        return res;
    },
    set(target, key, value, recevier) {

        let oldValue = (target as any)[key]
        // å¦‚æœæ”¹å˜å€¼äº†ï¼Œ å¯ä»¥åœ¨è¿™é‡Œè§¦å‘effectæ›´æ–°
        const res = Reflect.set(target, key, value, recevier); // target[key] = value

        if(oldValue !== value){ // å€¼ä¸å‘ç”Ÿå˜åŒ– effectä¸éœ€è¦é‡æ–°æ‰§è¡Œ
            trigger(target,key); // æ‰¾å±æ€§å¯¹åº”çš„effectè®©å¥¹é‡æ–°æ‰§è¡Œ
        }
        return res;
    }
}

```

## æ”¶é›†ä¾èµ–

```js
export function isTracking() {
    return activeEffect !== undefined
}
export function track(target, key) { // ä¸€ä¸ªå±æ€§å¯¹åº”å¤šä¸ªeffectï¼Œ ä¸€ä¸ªeffectä¸­ä¾èµ–äº†å¤šä¸ªå±æ€§ =ã€‹ å¤šå¯¹å¤š
    // æ˜¯åªè¦å–å€¼æˆ‘å°±è¦æ”¶é›†å—ï¼Ÿ
    if (!isTracking()) { // å¦‚æœè¿™ä¸ªå±æ€§ ä¸ä¾èµ–äºeffectç›´æ¥è·³å‡ºå³å¯
        return
    }
    let depsMap = targetMap.get(target);
    if (!depsMap) {
        targetMap.set(target, (depsMap = new Map())); // {å¯¹è±¡ï¼šmap{}}
    }
    let dep = depsMap.get(key);
    if (!dep) {
        depsMap.set(key, (dep = new Set()));// {å¯¹è±¡ï¼šmap{name:set[]}}
    }
    trackEffects(dep);

}
export function trackEffects(dep) {
    let shouldTrack = !dep.has(activeEffect); // çœ‹ä¸€ä¸‹è¿™ä¸ªå±æ€§æœ‰æ²¡æœ‰å­˜è¿‡è¿™ä¸ªeffect
    if (shouldTrack) {
        dep.add(activeEffect); // // {å¯¹è±¡ï¼šmap{name:set[effect,effect]}}
        activeEffect.deps.push(dep); // ç¨åç”¨åˆ°
    } // { å¯¹è±¡ï¼š{name:set,age:set}

}
export function trigger(target, key) {
    let depsMap = targetMap.get(target);
    if (!depsMap) return;// å±æ€§ä¿®æ”¹çš„å±æ€§ æ ¹æœ¬æ²¡æœ‰ä¾èµ–ä»»ä½•çš„effect
    let deps = []; // [set ,set ]
    if (key !== undefined) {
        deps.push(depsMap.get(key));
    }
    let effects = [];
    for (const dep of deps) {
        effects.push(...dep)
    }
    triggerEffects(effects);
}
export function triggerEffects(dep) {

    const effects:any = new Set(dep)
    for (const effect of effects) { // å¦‚æœå½“å‰effectæ‰§è¡Œ å’Œ è¦æ‰§è¡Œçš„effectæ˜¯åŒä¸€ä¸ªï¼Œä¸è¦æ‰§è¡Œäº† é˜²æ­¢å¾ªç¯
        if (effect !== activeEffect) {
            if (effect.scheduler) {
                return effect.scheduler()
            }
            effect.run(); // æ‰§è¡Œeffect
        }
    }
}

```

## effect


```js
let effectStack = []; // ç›®çš„å°±æ˜¯ä¸ºäº†èƒ½ä¿è¯æˆ‘ä»¬effectæ‰§è¡Œçš„æ—¶å€™ å¯ä»¥å­˜å‚¨æ­£ç¡®çš„å…³ç³»
let activeEffect;

function cleanupEffect(effect) {
    const { deps } = effect;
     // ä»æ‰€æœ‰ deps ä¸­ç§»é™¤å½“å‰ effect
     for (let i = 0; i < effect.deps.length; i++) {
        effect.deps[i].delete(effect);
    }
    // æ¸…ç©º deps
    effect.deps.length = 0;
}
// å±æ€§å˜åŒ– è§¦å‘çš„æ˜¯ dep -> effect
// effect.deps = [] å’Œå±æ€§æ˜¯æ²¡å…³ç³»çš„
export class ReactiveEffect {
    active = true; // this.active = true;
    deps = []; // è®©effect è®°å½•ä»–ä¾èµ–äº†å“ªäº›å±æ€§ ï¼Œ åŒæ—¶è¦è®°å½•å½“å‰å±æ€§ä¾èµ–äº†å“ªä¸ªeffect
    constructor(public fn, public scheduler?) { // this.fn = fn;

    }
    run() { // è°ƒç”¨runçš„æ—¶å€™ä¼šè®©fnæ‰§è¡Œ
        if (!this.active) { // ç¨åå¦‚æœéæ¿€æ´»çŠ¶æ€ è°ƒç”¨runæ–¹æ³• é»˜è®¤ä¼šæ‰§è¡Œfnå‡½æ•°
            return this.fn();
        }
        if (!effectStack.includes(this)) { // å±è”½åŒä¸€ä¸ªeffectä¼šå¤šæ¬¡æ‰§è¡Œ
            try {
                effectStack.push(activeEffect = this);
                cleanupEffect(this)
                return this.fn(); // å–å€¼  new Proxy ä¼šæ‰§è¡Œgetæ–¹æ³•  (ä¾èµ–æ”¶é›†)
            } finally {
                effectStack.pop(); // åˆ é™¤æœ€åä¸€ä¸ª
                activeEffect = effectStack[effectStack.length - 1]
            }
        }
    }
    stop() { // è®©effect å’Œ dep å–æ¶ˆå…³è” depä¸Šé¢å­˜å‚¨çš„effectç§»é™¤æ‰å³å¯
        if (this.active) {
            cleanupEffect(this)
            this.active = false;
        }
    }
}
export function effect(fn) {
    const _effect = new ReactiveEffect(fn);
    _effect.run(); // ä¼šé»˜è®¤è®©fnæ‰§è¡Œä¸€æ¬¡
    let runner = _effect.run.bind(_effect);
    runner.effect = _effect; // ç»™runneræ·»åŠ ä¸€ä¸ªeffectå®ç° å°±æ˜¯ effectå®ä¾‹
    return runner;
}
```

## watch

```js

function traverse(value, seen = new Set()) {
   if (!isObject(value)) {
      return value;
    }
    // å¦‚æœå·²ç»å¾ªç¯äº†è¿™ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆåœ¨å¾ªç¯ä¼šå¯¼è‡´æ­»å¾ªç¯
    if (seen.has(value)) {
      return value;
    }
    seen.add(value);
    for (const key in value) {
      traverse(value[key], seen); // è§¦å‘å±æ€§çš„hetter
    }
    return value;
}
// å¿…é¡»ç›‘å¬çš„æ˜¯å“åº”å¼å¯¹è±¡
export function watch(source,cb,) {
let getter;
   if(isReactive(source)) {
      // å¯¹æ‰€æœ‰å¯¹è±¡çš„å±æ€§è¿›è¡Œç›‘å¬
      getter = () => traverse(source); // ğŸ‘ˆ æ·±åº¦è§¦å‘ä¾èµ–æ”¶é›†

   }else if(isFunction(source)) {
       // ç›‘å¬å‡½æ•°
        getter = source;
   }
   let oldValue;
   let clear;
   let onCleanup = (fn) => {
      clear = fn;
   }
   const job = () => {
      if(cb){
         if(clear) {
            clear();
         }
         const newValue = effect.run(); 
         cb(newValue,oldValue,onCleanup);
         oldValue = newValue;
      }else {
         effect.run(); //watchEffect ç›´æ¥æ‰§è¡Œå°±å¯ä»¥
      }
   }
   // TODO æ•°æ®å˜åŒ–ä¼šæ‰§è¡Œå¯¹åº”çš„schedule getter fn  æ”¶é›†å½“å‰çš„ä¾èµ–
   const effect = new ReactiveEffect(getter,job)
   oldValue = effect.run();
}

```

### watch flush çš„ç”¨æ³• 

`watch` ä¸­çš„ `flush` é€‰é¡¹ï¼ˆä¸æ˜¯ `pre` å’Œ `post`ï¼‰æ§åˆ¶çš„æ˜¯ **å›è°ƒå‡½æ•°çš„æ‰§è¡Œæ—¶æœº**ï¼Œå¸¸ç”¨å€¼æ˜¯ï¼š

```ts
watch(source, callback, {
  flush: 'pre' | 'post' | 'sync'
});
```

### ğŸ” ä¸‰ç§å–å€¼çš„å«ä¹‰

| å€¼        | æ‰§è¡Œæ—¶æœº                  | è¯´æ˜                   |
| -------- | --------------------- | -------------------- |
| `'pre'`  | åœ¨ç»„ä»¶æ¸²æŸ“ **ä¹‹å‰**          | é»˜è®¤å€¼ï¼Œé€‚åˆä¾èµ–å“åº”å¼æ•°æ®çš„ watch |
| `'post'` | åœ¨ç»„ä»¶æ¸²æŸ“ **ä¹‹å**ï¼ˆDOM å·²æ›´æ–°ï¼‰ | å¸¸ç”¨äºè®¿é—® DOM æ›´æ–°åçš„çŠ¶æ€     |
| `'sync'` | **åŒæ­¥ç«‹å³** æ‰§è¡Œ callback  | ä¸ç­‰å¾…å¼‚æ­¥é˜Ÿåˆ—ï¼Œç«‹å³è§¦å‘ï¼ˆä¸æ¨èé¢‘ç¹ç”¨ï¼‰ |

---

## âœ… ä¸¾ä¾‹è¯´æ˜

### ç¤ºä¾‹ç»„ä»¶ï¼š

```ts
const count = ref(0)

watch(
  () => count.value,
  (newVal, oldVal) => {
    console.log('watch callback:', newVal)
  },
  { flush: 'post' } // æˆ– 'pre' æˆ– 'sync'
)
```

```vue
<template>
  <div ref="el">{{ count }}</div>
</template>
```

---

### ğŸ§ª flush: 'pre'ï¼ˆé»˜è®¤å€¼ï¼‰

* æ‰§è¡Œæ—¶æœºï¼š**ç»„ä»¶æ›´æ–°å‰**ï¼ˆDOM è¿˜æ²¡å˜ï¼‰
* é€‚åˆåœºæ™¯ï¼š**ä¾èµ–å“åº”å¼æ•°æ®**åšå‰¯ä½œç”¨è®¡ç®—

```ts
watch(source, callback, { flush: 'pre' });
```

---

### ğŸ§ª flush: 'post'

* æ‰§è¡Œæ—¶æœºï¼š**ç»„ä»¶æ›´æ–°åï¼ˆDOM å·²æ¸²æŸ“ï¼‰**
* é€‚åˆåœºæ™¯ï¼š**éœ€è¦è®¿é—®æ›´æ–°åçš„ DOM**

```ts
watch(source, callback, { flush: 'post' });
```

```ts
watch(() => count.value, (newVal) => {
  nextTick(() => {
    console.log('DOM å·²æ›´æ–°ï¼Œå¯ä»¥æ“ä½œ this.$refs.el')
  })
}, { flush: 'post' })
```

---

### ğŸ§ª flush: 'sync'

* æ‰§è¡Œæ—¶æœºï¼š**ç«‹å³æ‰§è¡Œï¼Œä¸è¿›é˜Ÿåˆ—**
* åœºæ™¯ï¼š**ä¸ç­‰å¾… DOM æ›´æ–°çš„åœºæ™¯ï¼ˆå¦‚å¿«é€ŸåŒæ­¥æ ¡éªŒï¼‰**

```ts
watch(source, callback, { flush: 'sync' });
```

> âš ï¸ æ³¨æ„ï¼šä½¿ç”¨ `'sync'` å¯èƒ½ä¼šé€ æˆå¤šæ¬¡ DOM æ›´æ–°ï¼Œæ€§èƒ½è¾ƒå·®ã€‚

---

## âœ… æ¨èä½¿ç”¨æŒ‡å—

| åœºæ™¯            | æ¨è flush       |
| ------------- | -------------- |
| æ“ä½œ DOM        | `'post'`       |
| æ“ä½œå“åº”å¼æ•°æ®ã€ä¸€èˆ¬å‰¯ä½œç”¨ | `'pre'`ï¼ˆé»˜è®¤ï¼‰    |
| éœ€è¦åŒæ­¥ç«‹å³å¤„ç†      | `'sync'`ï¼ˆå°å¿ƒä½¿ç”¨ï¼‰ |

---


## computed

å®ƒå…¶å®åšäº†è¿™äº›äº‹ï¼š

- åˆ›å»ºä¸€ä¸ªå†…éƒ¨çš„ lazy effectï¼›

- åœ¨è®¿é—® .value æ—¶æ‰æ‰§è¡Œè®¡ç®—ï¼ˆæ‡’æ‰§è¡Œï¼‰

- å½“ä¾èµ–å˜åŒ–æ—¶ï¼ŒæŠŠ dirty è®¾ä¸º trueï¼›

- å†æ¬¡è®¿é—® .value æ—¶é‡æ–°è®¡ç®—ï¼Œå¹¶ç¼“å­˜ç»“æœï¼›

- æ²¡æœ‰å˜åŒ–æ—¶è®¿é—® .value ç›´æ¥è¿”å›ç¼“å­˜ã€‚

```js
class ComputedRefImpl {
    public dep; // this.dep = undefined;
    public _dirty = true; // this._dirty = true;
    public __v_isRef = true;
    public effect; // è®¡ç®—å±æ€§æ˜¯ä¾èµ–äºeffectçš„
    public _value;
    constructor(getter, public setter) { // åªæœ‰è°ƒç”¨computed()æ‰æ‰§è¡Œä¸€æ¬¡
        // è¿™é‡Œå°†è®¡ç®—å±æ€§åŒ…æˆä¸€ä¸ªeffect
        // è¿™é‡Œ æˆ‘ç»™è®¡ç®—å±æ€§å˜æˆäº†effect ï¼Œé‚£ä¹ˆè®¡ç®—å±æ€§ä¸­çš„å±æ€§ä¼šæ”¶é›†è¿™ä¸ªeffect
        this.effect = new ReactiveEffect(getter,()=>{
            // ç¨åè®¡ç®—å±æ€§ä¾èµ–çš„å€¼å˜åŒ– ä¸è¦é‡æ–°æ‰§è¡Œè®¡ç®—å±æ€§çš„effectï¼Œè€Œæ˜¯è°ƒç”¨æ­¤å‡½æ•°
            if(!this._dirty){
                this._dirty = true;
                triggerEffects(this.dep ) // è§¦å‘æ¸²æŸ“
            }
        });
    }
    get value() { // å–å€¼æ—¶ä¼šèµ°getæ–¹æ³•
        if (isTracking()) { // æ˜¯å¦æ˜¯åœ¨effectä¸­å–å€¼çš„
            trackEffects(this.dep || (this.dep = new Set))
        }
        if (this._dirty) {
            // å°†ç»“æœç¼“å­˜åˆ°this._value è¿™æ ·å°±ä¸ç”¨æ¯æ¬¡éƒ½runäº†
            this._value = this.effect.run();
            this._dirty = false;
        }
        return this._value;
    }
    set value(newValue) {
        this.setter(newValue); // å¦‚æœä¿®æ”¹è®¡ç®—å±æ€§çš„å€¼ å°±è§¦å‘ä½ è‡ªå·±çš„setæ–¹æ³•
    }
}
export function computed(getterOrOptions) {
    const onlyGetter = isFunction(getterOrOptions);
    let getter;
    let setter;
    if (onlyGetter) {
        getter = getterOrOptions;
        setter = () => { }
    } else {
        getter = getterOrOptions.get;
        setter = getterOrOptions.set;
    }

    return new ComputedRefImpl(getter, setter)
}

```

## æµ…è°ˆ ReactiveEffect è®¾è®¡

åœ¨ Vue 3 å“åº”å¼ç³»ç»Ÿä¸­ï¼Œ`ReactiveEffect` æ˜¯å‰¯ä½œç”¨ï¼ˆ`effect`ï¼‰çš„æ ¸å¿ƒç±»ã€‚è€Œ **è®¾ç½®è°ƒåº¦å™¨ï¼ˆ`scheduler`ï¼‰çš„ä½œç”¨**ï¼Œå¯ä»¥æ¦‚æ‹¬ä¸ºï¼š

---

## âœ… **è°ƒåº¦å™¨çš„ä½œç”¨ï¼šæ§åˆ¶å‰¯ä½œç”¨å‡½æ•°ï¼ˆ`fn`ï¼‰çš„æ‰§è¡Œæ—¶æœºå’Œæ–¹å¼**

---

## âœ³ï¸ é»˜è®¤è¡Œä¸ºï¼ˆæ²¡æœ‰ schedulerï¼‰

å½“å“åº”å¼æ•°æ®å˜åŒ–æ—¶ï¼ŒVue ä¼šç«‹å³æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼š

```ts
effect(() => {
  console.log(state.count)
})
```

å½“ `state.count++`ï¼Œä¼šé©¬ä¸Šé‡æ–°æ‰§è¡Œ `effect.fn()`ã€‚

---

## âœ³ï¸ ä½¿ç”¨ `scheduler` çš„è¡Œä¸º

å½“ä½ è®¾ç½®äº†è°ƒåº¦å™¨å‡½æ•°ï¼š

```ts
effect(() => {
  console.log(state.count)
}, {
  scheduler: () => {
    console.log('è°ƒåº¦å™¨è§¦å‘äº†ï¼')
  }
})
```

æ­¤æ—¶ï¼Œå“åº”å¼æ•°æ®å˜åŒ– **ä¸ä¼šç›´æ¥æ‰§è¡Œ `fn()`**ï¼Œè€Œæ˜¯ï¼š

```ts
// Vue å†…éƒ¨ï¼š
if (effect.scheduler) {
  effect.scheduler(); // æ§åˆ¶æƒäº¤ç»™ä½ 
} else {
  effect.run(); // é»˜è®¤è¡Œä¸º
}
```

---

## ğŸ¯ ä¸»è¦ç”¨é€”

### 1. **æ‰¹é‡æ›´æ–°ï¼ˆå¼‚æ­¥é˜Ÿåˆ—ï¼‰**

è°ƒåº¦å™¨å¸¸ç”¨äº **å°†å‰¯ä½œç”¨å‡½æ•°æ¨å…¥å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—**ï¼Œç­‰åˆ°ä¸‹ä¸€è½®å¾®ä»»åŠ¡ä¸€èµ·æ›´æ–°ï¼š

```ts
import { queueJob } from './scheduler'

effect(() => {
  console.log(state.count)
}, {
  scheduler: job => queueJob(job)
})
```

è¿™æ ·å¯ä»¥é¿å…é¢‘ç¹ DOM æ›´æ–°ã€‚

---

### 2. **æ§åˆ¶å‰¯ä½œç”¨é¢‘ç‡ï¼ˆèŠ‚æµã€å»æŠ–ï¼‰**

```ts
effect(() => {
  console.log(window.scrollY)
}, {
  scheduler: throttle(() => {
    console.log('èŠ‚æµæ‰§è¡Œ')
  }, 200)
})
```

---

### 3. **å®ç° `watch` å’Œ `computed`**

Vue å†…éƒ¨ä¹Ÿæ˜¯å€ŸåŠ© `scheduler` å®ç°è¿™äº›é«˜çº§ç‰¹æ€§ï¼š

#### ğŸ§  `watch` ä½¿ç”¨ scheduler å»¶è¿Ÿè§¦å‘å›è°ƒï¼š

```ts
effect(getter, {
  lazy: true,
  scheduler: () => {
    job(); // job ä¸­ä¼šæ‰§è¡Œ watch å›è°ƒ
  }
})
```

#### ğŸ§  `computed` ç”¨ scheduler æ§åˆ¶ä¾èµ–å˜æ›´æ—¶ dirty æ ‡å¿—è®¾ç½®ä¸º trueï¼Œè€Œä¸æ˜¯ç›´æ¥æ±‚å€¼ï¼š

```ts
this.effect = new ReactiveEffect(getter, () => {
  this._dirty = true;
  trigger(this, 'value');
})
```

---

## âœ… æ€»ç»“ä¸€å¥è¯ï¼š

> `scheduler` æ˜¯ Vue å“åº”å¼ç³»ç»Ÿä¸­ **â€œæŠŠ effect ä½•æ—¶æ‰§è¡Œçš„æ§åˆ¶æƒäº¤ç»™ä½ â€** çš„æœºåˆ¶ï¼Œæ˜¯æ„å»ºé«˜çº§ç‰¹æ€§çš„åŸºç¡€å·¥å…·ã€‚

---



---
title:  Vue3 æ¨¡æ¿ç¼–è¯‘ä¼˜åŒ–
tags:
  - vue
---


ä¸‹é¢æ–‡ç« ä» **æ¨¡æ¿ç¼–è¯‘ä¼˜åŒ–** çš„å‡ ä¸ªæ ¸å¿ƒç»´åº¦å…¥æ‰‹ï¼Œç»“åˆå¤šç¯‡å®æˆ˜ä¸æºç è§£æï¼Œå…¨é¢ä»‹ç» Vue 3 å¦‚ä½•é€šè¿‡é™æ€åˆ†æä¸ç¼–è¯‘æ—¶æ ‡è®°ï¼Œå‡å°‘è¿è¡Œæ—¶æˆæœ¬ã€åŠ é€Ÿè™šæ‹Ÿ DOM æ¸²æŸ“ã€‚

Vue 3 çš„æ¨¡æ¿ç¼–è¯‘ä¼˜åŒ–ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ç‚¹ï¼š  
- **é™æ€æå‡ï¼ˆStatic Hoistingï¼‰**ï¼šå°†çœŸæ­£ä¸å˜çš„èŠ‚ç‚¹æå–åˆ°æ¸²æŸ“å‡½æ•°å¤–å±‚ï¼Œé¿å…æ¯æ¬¡é‡æ–°åˆ›å»º  ([vue3ç¼–è¯‘ä¼˜åŒ–ä¹‹â€œé™æ€æå‡â€ - å‰ç«¯æ¬§é˜³- åšå®¢å›­](https://www.cnblogs.com/heavenYJJ/p/18190230?utm_source=chatgpt.com))ã€‚  
- **Patch Flag & Block Tree**ï¼šç¼–è¯‘å™¨ä¸ºåŠ¨æ€èŠ‚ç‚¹æ‰“ä¸Šç²¾ç»†çš„â€œæ›´æ–°æ ‡è®°â€ï¼Œå¹¶ç”¨ Block Tree+dynamicChildren åˆ—å‡ºçœŸæ­£éœ€æ›´æ–°çš„å­æ ‘ï¼Œè·³è¿‡å¤§éƒ¨åˆ†æ¯”å¯¹  ([vue3.0æ€§èƒ½ä¼˜åŒ–ç‚¹ä¹‹é™æ€æ ‡è®°(PatchFlag) åŸåˆ› - CSDNåšå®¢](https://blog.csdn.net/weixin_40297452/article/details/121143356?utm_source=chatgpt.com), [ä»é¢è¯•é¢˜å…¥æ‰‹ï¼Œç•…è°ˆVue 3 æ€§èƒ½ä¼˜åŒ–-æ”¯ä»˜å®å¼€å‘è€…ç¤¾åŒº](https://open.alipay.com/portal/forum/post/108301027?utm_source=chatgpt.com))ã€‚  
- **äº‹ä»¶ä¸å±æ€§ç»‘å®šä¼˜åŒ–**ï¼šå¯¹åŠ¨æ€ classã€styleã€props å’Œäº‹ä»¶å¤„ç†å‡½æ•°ç”Ÿæˆæœ€å°åŒ–çš„æ›´æ–°é€»è¾‘ï¼Œå¤ç”¨ç›¸åŒå›è°ƒå¹¶å‡å°‘å¼€é”€  ([Vue3 Compiler ä¼˜åŒ–ç»†èŠ‚ï¼Œå¦‚ä½•æ‰‹å†™é«˜æ€§èƒ½æ¸²æŸ“å‡½æ•° - çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/p/150732926?utm_source=chatgpt.com), [Rendering Mechanism - Vue.js](https://vuejs.org/guide/extras/rendering-mechanism?utm_source=chatgpt.com))ã€‚  
- **æŒ‡ä»¤ä¸æ’æ§½ç¼–è¯‘**ï¼šå¯¹å†…ç½®æŒ‡ä»¤ï¼ˆå¦‚ v-forã€v-ifï¼‰å’Œæ’æ§½åšç‰¹æ®Šä»£ç ç”Ÿæˆï¼Œæå‰è®¡ç®—åˆ†æ”¯ä¸ç¼“å­˜ç»“æœ  ([Vue3 æ¨¡æ¿ç¼–è¯‘åŸç† - çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/p/181505806?utm_source=chatgpt.com), [Built-in Directives | Vue.js](https://vuejs.org/api/built-in-directives.html?utm_source=chatgpt.com))ã€‚  

---

## ğŸ“ æ¨¡æ¿ç¼–è¯‘æ¦‚è§ˆ

Vue 3 åœ¨ç¼–è¯‘é˜¶æ®µé€šè¿‡ AST åˆ†ææ¨¡æ¿ï¼Œå°† `template` è½¬æ¢æˆé«˜æ•ˆçš„æ¸²æŸ“å‡½æ•°ï¼ˆ`render`ï¼‰ï¼Œå¹¶åœ¨è¿‡ç¨‹ä¸­æ”¶é›†å„ç§é™æ€å’ŒåŠ¨æ€ä¿¡æ¯ï¼š  
1. **é™æ€èŠ‚ç‚¹æ£€æµ‹**ï¼šåˆ¤æ–­å“ªäº›å…ƒç´ æˆ–æ–‡æœ¬ä¸ä¼šéšçŠ¶æ€æ”¹å˜  ([Vue3 æºç è§£æï¼ˆä¸‰ï¼‰ï¼šé™æ€æå‡ - ææ™“çš„åšå®¢](https://originalix.github.io/2021/05/10/Vue3%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%28%E4%B8%89%29-%E9%9D%99%E6%80%81%E6%8F%90%E5%8D%87/?utm_source=chatgpt.com))ã€‚  
2. **Patch Flag æ ‡è®°**ï¼šä¸ºåŠ¨æ€å±æ€§å’Œå­èŠ‚ç‚¹ç±»å‹æ·»åŠ æšä¸¾å€¼æ¥æŒ‡ç¤ºæ›´æ–°ç­–ç•¥  ([core/packages/shared/src/patchFlags.ts at main Â· vuejs/core - GitHub](https://github.com/vuejs/core/blob/main/packages/shared/src/patchFlags.ts?utm_source=chatgpt.com))ã€‚  
3. **Block Tree åˆ†å—**ï¼šå°†æ•´ä¸ª VNode æ ‘æ‹†åˆ†ä¸ºâ€œé™æ€å—â€ä¸â€œåŠ¨æ€å—â€ï¼ŒåŠ¨æ€å—å†…éƒ¨å†ç”¨ `dynamicChildren` æ•°ç»„å­˜æ”¾æœ€å°æ›´æ–°å•å…ƒ  ([vue3çš„æ”¹å˜ï¼ˆhoist ä¸Blockï¼‰ - ç¨€åœŸæ˜é‡‘](https://juejin.cn/post/7084597196359745573?utm_source=chatgpt.com))ã€‚  

è¿™æ ·ä¸€æ¬¡ç¼–è¯‘å°±æŠŠâ€œå“ªäº›å†…å®¹ä¼šå˜â€â€œæ€ä¹ˆå˜â€éƒ½é¢„å…ˆç®—å¥½äº†ï¼Œè¿è¡Œæ—¶åªåšå¿…è¦çš„æ¯”å¯¹å’Œæ›´æ–°ï¼Œå¤§å¤§æå‡æ¸²æŸ“é€Ÿåº¦  ([Vue3ç³»åˆ—ä¸‰ï¼šæ¨¡ç‰ˆç¼–è¯‘åŠä¼˜åŒ–çš„æºç è§£æ - ç¨€åœŸæ˜é‡‘](https://juejin.cn/post/7247324653840367675?utm_source=chatgpt.com))ã€‚

---

## ğŸš€ é™æ€æå‡ï¼ˆStatic Hoistingï¼‰

### åŸç†ä¸ç›®çš„  
- **åŸç†**ï¼šå°† AST ä¸­å¯å®Œå…¨ç¡®å®šä¸ºå¸¸é‡çš„èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬å±æ€§ã€æ–‡æœ¬ã€æ ·å¼å¯¹è±¡ï¼‰åœ¨ç¼–è¯‘æ—¶æŠ½å–æˆé¡¶å±‚å˜é‡ï¼Œæ¸²æŸ“å‡½æ•°æ‰§è¡Œæ—¶ç›´æ¥å¼•ç”¨ï¼Œä¸å†æ¯æ¬¡é‡å»º VNode  ([vue3ç¼–è¯‘ä¼˜åŒ–ä¹‹â€œé™æ€æå‡â€ - å‰ç«¯æ¬§é˜³- åšå®¢å›­](https://www.cnblogs.com/heavenYJJ/p/18190230?utm_source=chatgpt.com))ã€‚  
- **ç›®çš„**ï¼šé¿å…é‡å¤åˆ›å»ºç›¸åŒçš„ VNode å¯¹è±¡ï¼Œå‡å°‘åƒåœ¾å›æ”¶å’Œå†…å­˜åˆ†é…æˆæœ¬ã€‚

### æºç å®ç°  
- åœ¨ `optimize` é˜¶æ®µä¸ºé™æ€èŠ‚ç‚¹æ‰“ä¸Š `HOISTED` æ ‡è®°ï¼ˆ`PatchFlags.HOISTED`ï¼‰å¹¶æ”¶é›†åˆ° `ast.hoists` æ•°ç»„ä¸­  ([Vue3 æºç è§£æï¼ˆä¸‰ï¼‰ï¼šé™æ€æå‡ - ææ™“çš„åšå®¢](https://originalix.github.io/2021/05/10/Vue3%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%28%E4%B8%89%29-%E9%9D%99%E6%80%81%E6%8F%90%E5%8D%87/?utm_source=chatgpt.com))ã€‚  
- åœ¨ `codegen` é˜¶æ®µè°ƒç”¨ `genHoists(ast.hoists, context)` ç”Ÿæˆè¯¸å¦‚ `_hoisted_1 = createElementVNode('div', ... )` çš„é¡¶å±‚å¸¸é‡å£°æ˜ã€‚  

---

## ğŸ¯ Patch Flag ä¸ Block Tree

### Patch Flag ç²¾ç»†æ ‡è®°  
- **PatchFlags æšä¸¾**ï¼šåŒ…å« `TEXT`ã€`CLASS`ã€`STYLE`ã€`PROPS`ã€`FULL_PROPS`ã€`STABLE_FRAGMENT` ç­‰æ ‡è¯†  ([vue3.0æ€§èƒ½ä¼˜åŒ–ç‚¹ä¹‹é™æ€æ ‡è®°(PatchFlag) åŸåˆ› - CSDNåšå®¢](https://blog.csdn.net/weixin_40297452/article/details/121143356?utm_source=chatgpt.com), [core/packages/shared/src/patchFlags.ts at main Â· vuejs/core - GitHub](https://github.com/vuejs/core/blob/main/packages/shared/src/patchFlags.ts?utm_source=chatgpt.com))ã€‚  
- **ä½œç”¨**ï¼šè¿è¡Œæ—¶ `patchElement` æ£€æµ‹ `vnode.patchFlag`ï¼Œåªæ›´æ–°å¯¹åº”éƒ¨åˆ†ï¼Œå¦‚ï¼š
  ```js
  if (vnode.patchFlag & PatchFlags.CLASS) {
    // ä»…æ›´æ–° class
  }
  ```
   ([Rendering Mechanism - Vue.js](https://vuejs.org/guide/extras/rendering-mechanism?utm_source=chatgpt.com))

### Block Tree + dynamicChildren  
- **Block Tree**ï¼šåœ¨æ¸²æŸ“å‡½æ•°ä¸­ç”¨ `_openBlock()` / `_createElementBlock()` ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰ `dynamicChildren` æ•°ç»„çš„æ ¹èŠ‚ç‚¹å—  ([Rendering Mechanism - Vue.js](https://vuejs.org/guide/extras/rendering-mechanism?utm_source=chatgpt.com))ã€‚  
- **dynamicChildren**ï¼šä»…å­˜æ”¾è¯¥å—å†…æ‰“äº† Patch Flag çš„å­èŠ‚ç‚¹ï¼Œdiff æ—¶åªéå†è¿™é‡Œï¼Œä¸å†èµ°å…¨æ ‘é€’å½’  ([ä»é¢è¯•é¢˜å…¥æ‰‹ï¼Œç•…è°ˆVue 3 æ€§èƒ½ä¼˜åŒ–-æ”¯ä»˜å®å¼€å‘è€…ç¤¾åŒº](https://open.alipay.com/portal/forum/post/108301027?utm_source=chatgpt.com))ã€‚

---

## ğŸ”„ äº‹ä»¶ä¸ç»‘å®šä¼˜åŒ–

### å¤ç”¨äº‹ä»¶å¤„ç†å‡½æ•°  
- ç¼–è¯‘å™¨å¯¹åŒä¸€å¤„ç†å‡½æ•°åšç¼“å­˜ï¼šå½“æ£€æµ‹åˆ° `onClick="doSomething"` ç›¸åŒå­—ç¬¦ä¸²æ—¶ï¼Œå¤ç”¨åŒä¸€ä¸ªå‡½æ•°å¼•ç”¨ï¼Œé¿å…åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶é‡æ–°ç”ŸæˆåŒ¿åå‡½æ•°  ([Vue3 Compiler ä¼˜åŒ–ç»†èŠ‚ï¼Œå¦‚ä½•æ‰‹å†™é«˜æ€§èƒ½æ¸²æŸ“å‡½æ•° - çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/p/150732926?utm_source=chatgpt.com))ã€‚

### åŠ¨æ€å±æ€§å¿«é€Ÿè·¯å¾„  
- å¯¹ `:class`ã€`:style`ã€æ™®é€šå±æ€§å’Œ DOM Prop åˆ†åˆ«èµ°ä¸åŒçš„æ›´æ–°åˆ†æ”¯ï¼Œå‡å°‘å±æ€§æ¯”å¯¹çš„å¯¹è±¡åˆ›å»ºå’Œåå°„è°ƒç”¨  ([vue3.0æ€§èƒ½ä¼˜åŒ–ç‚¹ä¹‹é™æ€æ ‡è®°(PatchFlag) åŸåˆ› - CSDNåšå®¢](https://blog.csdn.net/weixin_40297452/article/details/121143356?utm_source=chatgpt.com))ã€‚  
- `style="color:red"` ä¼šè¢«å­—ç¬¦ä¸²è½¬æ¢ä¸ºé™æ€å¯¹è±¡å¹¶æå‡ï¼Œ`:style` ç»‘å®šçš„è¡¨è¾¾å¼åˆ™åªæ›´æ–°å˜åŠ¨å­—æ®µ  ([vue3.0æ€§èƒ½ä¼˜åŒ–ç‚¹ä¹‹é™æ€æ ‡è®°(PatchFlag) åŸåˆ› - CSDNåšå®¢](https://blog.csdn.net/weixin_40297452/article/details/121143356?utm_source=chatgpt.com))ã€‚

---

## ğŸ›  æŒ‡ä»¤ä¸æ’æ§½ç¼–è¯‘ä¼˜åŒ–

### å†…ç½®æŒ‡ä»¤ï¼ˆv-for/v-ifï¼‰  
- **v-for**ï¼šç¼–è¯‘ä¸º `renderList(source, (item, index) => ...)`ï¼Œå¹¶é»˜è®¤å‡è®¾é¡ºåºä¸å˜ï¼Œæ—  key ä¸ç§»åŠ¨  ([Built-in Directives | Vue.js](https://vuejs.org/api/built-in-directives.html?utm_source=chatgpt.com))ã€‚  
- **v-if/v-else**ï¼šç¼–è¯‘ä¸ºä¸‰å…ƒè¡¨è¾¾å¼æˆ– `renderBlock` è°ƒç”¨ï¼Œåªåœ¨æ¡ä»¶å˜åŒ–æ—¶åˆ›å»ºæˆ–ç§»é™¤å¯¹åº”å­æ ‘  ([Vue3 æ¨¡æ¿ç¼–è¯‘åŸç† - çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/p/181505806?utm_source=chatgpt.com))ã€‚

### æ’æ§½ï¼ˆSlotsï¼‰  
- parent ä¾§åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆ `renderSlot(_ctx.$slots, 'default', props)` è°ƒç”¨  
- child ä¾§ä½¿ç”¨ `resolveSlots` åœ¨è¿è¡Œæ—¶å°† slot VNode æ¸²æŸ“å‡½æ•°ç¼“å­˜åˆ° `instance.slots` å¯¹è±¡  ([Vue3 æ¨¡æ¿ç¼–è¯‘åŸç† - çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/p/181505806?utm_source=chatgpt.com))  
- è¿™æ · slot æ¸²æŸ“å‡½æ•°åªç”Ÿæˆä¸€æ¬¡ï¼Œæå‡æ•ˆç‡ã€‚

---

## ğŸ” å®è·µå»ºè®®

- **å¼€å¯ç”Ÿäº§æ¨¡å¼**ï¼šç¡®ä¿æ‰“åŒ…æ—¶å¯ç”¨ `__DEV__` ä¸º falseï¼Œä»¥ç§»é™¤å¼€å‘æ¨¡å¼çš„è­¦å‘Šå’Œæ–­è¨€ã€‚  
- **æ·»åŠ  `key`**ï¼šå¯¹åŠ¨æ€åˆ—è¡¨å§‹ç»ˆåŠ  `:key`ï¼Œå……åˆ†åˆ©ç”¨ Patch Flag çš„ FULL_PROPS + STABLE_FRAGMENT ä¼˜åŒ–  ([Vue3å°†Diffè¿›è¡Œäº†å“ªäº›ä¼˜åŒ–ï¼Ÿ - ä¸­åŸ¹ä¼Ÿä¸š](https://m.zpedu.com/it/rjyf/22028.html?utm_source=chatgpt.com))ã€‚  
- **é¿å…ç»‘å®šå¯¹è±¡å­—é¢é‡**ï¼šå°†æ ·å¼æˆ–å±æ€§å¯¹è±¡æå–ä¸ºå“åº”å¼æˆ–å¸¸é‡ï¼Œè§¦å‘é™æ€æå‡ã€‚  
- **åˆç†æ‹†åˆ†ç»„ä»¶**ï¼šå¯¹å¤§å‹å¤æ‚æ¨¡æ¿æ‹†åˆ†æˆå¤šä¸ªå°ç»„ä»¶ï¼Œåˆ©ç”¨ç¼–è¯‘æ—¶çš„å­æ ‘é™æ€åˆ†æå‡å°‘ diff ä»£ä»·ã€‚  

---

ä»¥ä¸Šè¯¸å¤šä¼˜åŒ–ç­–ç•¥ï¼Œä½¿ Vue 3 çš„æ¨¡æ¿ç¼–è¯‘ä¸æ¸²æŸ“åœ¨å…¸å‹åœºæ™¯ä¸‹æ¯” Vue 2 æ€§èƒ½æå‡ 2ï½3 å€ï¼Œæ¸²æŸ“å»¶è¿Ÿå’Œå†…å­˜å ç”¨æ˜¾è‘—ä¸‹é™  ([VUE3-diffç®—æ³•ä¸­çš„é™æ€æå‡ï¼ˆStatic Hoistingï¼‰ åŸåˆ› - CSDNåšå®¢](https://blog.csdn.net/weixin_64974855/article/details/131457309?utm_source=chatgpt.com), [vue3çš„æ”¹å˜ï¼ˆhoist ä¸Blockï¼‰ - ç¨€åœŸæ˜é‡‘](https://juejin.cn/post/7084597196359745573?utm_source=chatgpt.com))ã€‚  

> **å‚è€ƒé“¾æ¥**  
> - Vue 3 æ¨¡æ¿ç¼–è¯‘ä¼˜åŒ–å®æˆ˜ï¼šç¨€åœŸæ˜é‡‘  ([Vue3ç³»åˆ—ä¸‰ï¼šæ¨¡ç‰ˆç¼–è¯‘åŠä¼˜åŒ–çš„æºç è§£æ - ç¨€åœŸæ˜é‡‘](https://juejin.cn/post/7247324653840367675?utm_source=chatgpt.com))  
> - ã€Švue3ç¼–è¯‘ä¼˜åŒ–ä¹‹é™æ€æå‡ã€‹ï¼šåšå®¢å›­  ([vue3ç¼–è¯‘ä¼˜åŒ–ä¹‹â€œé™æ€æå‡â€ - å‰ç«¯æ¬§é˜³- åšå®¢å›­](https://www.cnblogs.com/heavenYJJ/p/18190230?utm_source=chatgpt.com))  
> - ã€ŠVue 3 æ€§èƒ½ä¼˜åŒ–ç‚¹ä¹‹é™æ€æ ‡è®°ã€‹ï¼šCSDN  ([vue3.0æ€§èƒ½ä¼˜åŒ–ç‚¹ä¹‹é™æ€æ ‡è®°(PatchFlag) åŸåˆ› - CSDNåšå®¢](https://blog.csdn.net/weixin_40297452/article/details/121143356?utm_source=chatgpt.com))  
> - PatchFlag å®˜æ–¹æ–‡æ¡£ï¼šVue æŒ‡å—  ([Rendering Mechanism - Vue.js](https://vuejs.org/guide/extras/rendering-mechanism?utm_source=chatgpt.com))  
> - PatchFlag æºç ï¼šGitHub vuejs/core  ([core/packages/shared/src/patchFlags.ts at main Â· vuejs/core - GitHub](https://github.com/vuejs/core/blob/main/packages/shared/src/patchFlags.ts?utm_source=chatgpt.com))  
> - Diff ç®—æ³•ä¼˜åŒ–ï¼šæ”¯ä»˜å®ç¤¾åŒº  ([ä»é¢è¯•é¢˜å…¥æ‰‹ï¼Œç•…è°ˆVue 3 æ€§èƒ½ä¼˜åŒ–-æ”¯ä»˜å®å¼€å‘è€…ç¤¾åŒº](https://open.alipay.com/portal/forum/post/108301027?utm_source=chatgpt.com))  
> - ç¼–è¯‘åŸç†è¯¦è§£ï¼šçŸ¥ä¹ä¸“æ   ([Vue3 æ¨¡æ¿ç¼–è¯‘åŸç† - çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/p/181505806?utm_source=chatgpt.com))
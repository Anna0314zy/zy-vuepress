# å·¥å…·æ‰“åŒ…

å¯¹äº TypeScript çš„ npm åŒ…æ‰“åŒ…ï¼ŒRollup å’Œ ESBuild éƒ½æ˜¯å¾ˆå¥½çš„é€‰æ‹©ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„å¯¹æ¯”å’Œå»ºè®®ï¼š

## ğŸ“Š Rollup vs ESBuild å¯¹æ¯”

| ç‰¹æ€§ | Rollup | ESBuild |
|:---|:---|:---|
| **æˆç†Ÿåº¦** | â­â­â­â­â­ æˆç†Ÿç¨³å®š | â­â­â­â­ ç›¸å¯¹è¾ƒæ–°ä½†å‘å±•è¿…é€Ÿ |
| **é…ç½®å¤æ‚åº¦** | â­â­â­ é…ç½®ç›¸å¯¹å¤æ‚ | â­â­â­â­â­ é…ç½®ç®€å• |
| **æ„å»ºé€Ÿåº¦** | â­â­â­ è¾ƒæ…¢ | â­â­â­â­â­ **æå¿«**(10-100x) |
| **Tree-shaking** | â­â­â­â­â­ **ä¼˜ç§€** | â­â­â­ è‰¯å¥½ |
| **è¾“å‡ºæ ¼å¼** | â­â­â­â­â­ æ”¯æŒå¤šç§æ ¼å¼ | â­â­â­ æœ‰é™æ”¯æŒ |
| **æ’ä»¶ç”Ÿæ€** | â­â­â­â­â­ ä¸°å¯Œ | â­â­â­ æ­£åœ¨å®Œå–„ |
| **TypeScriptæ”¯æŒ** | éœ€è¦æ’ä»¶ | â­â­â­â­â­ **åŸç”Ÿæ”¯æŒ** |

## ğŸ¯ é€‰æ‹©å»ºè®®

### é€‰æ‹© Rollup å¦‚æœï¼š
- éœ€è¦**å¤æ‚çš„ä»£ç åˆ†å‰²**å’Œ tree-shaking
- è¾“å‡º**å¤šç§æ¨¡å—æ ¼å¼**(ESM, CJS, UMD, IIFE)
- ä¾èµ–ä¸°å¯Œçš„**æ’ä»¶ç”Ÿæ€ç³»ç»Ÿ**
- ä¼ä¸šçº§é¡¹ç›®ï¼Œè¿½æ±‚ç¨³å®šæ€§

### é€‰æ‹© ESBuild å¦‚æœï¼š
- è¿½æ±‚**æè‡´çš„æ„å»ºé€Ÿåº¦**
- é¡¹ç›®ç›¸å¯¹ç®€å•ï¼Œä¸éœ€è¦å¤æ‚é…ç½®
- å¸Œæœ›**é›¶é…ç½®**æˆ–æœ€å°é…ç½®
- å¼€å‘ä½“éªŒä¼˜å…ˆ

## ğŸ”§ å…·ä½“é…ç½®ç¤ºä¾‹

### ESBuild é…ç½®ï¼ˆæ¨èç”¨äºå¤§å¤šæ•°TSåº“ï¼‰

```bash
npm install esbuild typescript --save-dev
```

**build.js**
```javascript
const { build } = require('esbuild');
const { dependencies, peerDependencies } = require('./package.json');

const sharedConfig = {
  entryPoints: ['src/index.ts'],
  bundle: true,
  minify: true,
  external: [
    ...Object.keys(dependencies || {}),
    ...Object.keys(peerDependencies || {}),
    'vue' // ç¡®ä¿ Vue å¤–éƒ¨åŒ–
  ],
};

// åŒæ—¶ç”Ÿæˆ ESM å’Œ CJS
build({
  ...sharedConfig,
  outfile: 'dist/index.esm.js',
  format: 'esm',
  target: ['es2018'],
});

build({
  ...sharedConfig,
  outfile: 'dist/index.cjs.js',
  format: 'cjs',
  target: ['es2018'],
});
```

**package.json é…ç½®**
```json
{
  "main": "dist/index.cjs.js",
  "module": "dist/index.esm.js",
  "types": "dist/index.d.ts",
  "files": ["dist"],
  "scripts": {
    "build": "node build.js",
    "dev": "node build.js --watch"
  }
}
```

### Rollup é…ç½®ï¼ˆç”¨äºå¤æ‚åº“ï¼‰

```bash
npm install rollup @rollup/plugin-typescript @rollup/plugin-node-resolve @rollup/plugin-commonjs rollup-plugin-dts --save-dev
```

**rollup.config.js**
```javascript
import typescript from '@rollup/plugin-typescript';
import resolve from '@rollup/plugin-node-resolve';
import commonjs from '@rollup/plugin-commonjs';
import dts from 'rollup-plugin-dts';

export default [
  {
    input: 'src/index.ts',
    external: ['vue'], // å¤–éƒ¨åŒ– Vue
    output: [
      {
        file: 'dist/index.esm.js',
        format: 'esm',
        sourcemap: true,
      },
      {
        file: 'dist/index.cjs.js',
        format: 'cjs',
        sourcemap: true,
      }
    ],
    plugins: [
      resolve(),
      commonjs(),
      typescript({
        declaration: false,
        outDir: 'dist'
      })
    ]
  },
  {
    input: 'dist/types/index.d.ts',
    output: [{ file: 'dist/index.d.ts', format: 'esm' }],
    plugins: [dts()],
  }
];
```

## ğŸš€ æ¨èæ–¹æ¡ˆ

### å¯¹äºå¤§å¤šæ•° Vue + TS ç»„ä»¶åº“ï¼Œæˆ‘æ¨èï¼š

**æŠ€æœ¯æ ˆï¼šESBuild + TypeScript**

**ç›®å½•ç»“æ„ï¼š**
```
your-package/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts      # ä¸»å…¥å£
â”‚   â”œâ”€â”€ components/   # ç»„ä»¶
â”‚   â””â”€â”€ utils/        # å·¥å…·å‡½æ•°
â”œâ”€â”€ dist/             # æ„å»ºè¾“å‡º
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

**æ¨èçš„ tsconfig.jsonï¼š**
```json
{
  "compilerOptions": {
    "target": "ES2018",
    "module": "ESNext",
    "lib": ["ES2018", "DOM"],
    "declaration": true,
    "outDir": "./dist",
    "strict": true,
    "moduleResolution": "node",
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "**/*.test.ts"]
}
```

**å®Œæ•´çš„æ„å»ºè„šæœ¬ï¼š**
```javascript
// build.js
const { build } = require('esbuild');
const { spawnSync } = require('child_process');

// ç”Ÿæˆç±»å‹å£°æ˜
spawnSync('tsc', ['--emitDeclarationOnly', '--outDir', 'dist'], {
  stdio: 'inherit'
});

// æ„å»º ESM å’Œ CJS
Promise.all([
  build({
    entryPoints: ['src/index.ts'],
    outfile: 'dist/index.esm.js',
    bundle: true,
    minify: true,
    format: 'esm',
    external: ['vue'],
    target: 'es2018',
  }),
  build({
    entryPoints: ['src/index.ts'],
    outfile: 'dist/index.cjs.js',
    bundle: true,
    minify: true,
    format: 'cjs',
    external: ['vue'],
    target: 'es2018',
  })
]).catch(() => process.exit(1));
```

## ğŸ’¡ æœ€ä½³å®è·µ

1. **åŒæ—¶è¾“å‡º ESM å’Œ CJS** æ ¼å¼ç¡®ä¿å…¼å®¹æ€§
2. **å¤–éƒ¨åŒ– Vue** å’Œå…¶ä»– peerDependencies
3. **ç”Ÿæˆç±»å‹å£°æ˜æ–‡ä»¶** (.d.ts)
4. **è®¾ç½®åˆé€‚çš„ target** ç¡®ä¿æµè§ˆå™¨å…¼å®¹æ€§
5. **é…ç½® files å­—æ®µ** åªå‘å¸ƒå¿…è¦æ–‡ä»¶

## ğŸ“¦ å®Œæ•´ package.json ç¤ºä¾‹

```json
{
  "name": "your-vue-package",
  "version": "1.0.0",
  "main": "dist/index.cjs.js",
  "module": "dist/index.esm.js",
  "types": "dist/index.d.ts",
  "files": ["dist"],
  "scripts": {
    "build": "node build.js",
    "dev": "node build.js --watch",
    "prepublishOnly": "npm run build"
  },
  "peerDependencies": {
    "vue": "^3.0.0"
  },
  "devDependencies": {
    "esbuild": "^0.19.0",
    "typescript": "^5.0.0",
    "vue": "^3.3.0"
  }
}
```

å¯¹äºå¤§å¤šæ•° Vue + TypeScript çš„ npm åŒ…ï¼Œ**ESBuild** æ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Œå› ä¸ºå®ƒæ„å»ºé€Ÿåº¦æå¿«ï¼Œé…ç½®ç®€å•ï¼Œèƒ½æ˜¾è‘—æå‡å¼€å‘ä½“éªŒã€‚åªæœ‰åœ¨éœ€è¦å¤æ‚ä»£ç åˆ†å‰²æˆ–ç‰¹æ®Šæ’ä»¶åŠŸèƒ½æ—¶ï¼Œæ‰è€ƒè™‘ä½¿ç”¨ Rollupã€‚


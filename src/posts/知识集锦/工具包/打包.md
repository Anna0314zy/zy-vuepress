# Tsup vs Rollup vs esbuild — 详尽对比与选型指南

> 目标读者：前端工程师、库/SDK 作者、构建工具选型决策者。

本文档结构：

1. 概览（快速结论）
2. 各工具简介
3. 核心能力对比（表格）
4. 深入解析：内部实现与行为差异
5. 典型使用场景与选型建议
6. 配置示例（tsup / rollup / esbuild）
7. 实务注意点与性能调优
8. 迁移与互操作指南
9. 常见问答（FAQ）

---

## 1. 概览（快速结论）

* **tsup**：围绕库/SDK 打包做的零配置封装。内部使用 `esbuild` 做大部分工作，提供 d.ts 生成、自动 external、兼容多格式输出等默认行为。适合想省心、快速产出 cjs/esm+d.ts 的 TypeScript 库。

* **esbuild**：极快的打包/编译器（用 Go 实现）。重点是速度：快速的 TypeScript -> JavaScript 转译、bundle、minify。缺点是生态较新、某些高级变换/插件能力有限；不原生生成 `.d.ts`。

* **rollup**：成熟、插件化的 JavaScript bundler。适合构建对兼容性、资源处理（CSS、图片、CommonJS 转换）有精细要求的库（例如 UI 组件库）。性能比 esbuild/tsup 慢，但可高度定制。

**简短选型**：

* 想要“最快且省事”构建 TypeScript 库 → `tsup`。
* 需要极致性能、可接受自己拼类型声明流程 → `esbuild`。
* 需要高度定制、对 output 兼容性/插件有复杂需求（比如组件库、legacy 支持）→ `rollup`。

---

## 2. 各工具简介

### tsup

* 简介：一个基于 `esbuild` 的封装器（CLI + 少量封装逻辑），提供一套库打包的合理默认值（多格式输出、d.ts、external dependencies、watch 模式等）。
* 典型命令：`tsup src/index.ts --format cjs,esm --dts --watch`

### esbuild

* 简介：由 Evan Wallace 开发的用 Go 写的极快编译器。支持打包、转译、压缩（minify）。速度优势明显；API 同时提供 CLI 与 JS API。
* 典型命令：`esbuild src/index.ts --bundle --outfile=dist/index.js --format=esm`

### rollup

* 简介：成熟的 JS bundler，插件生态完善，擅长 tree-shaking。常用于打包库与组件库（例如很多开源库的发布包采用 Rollup）。
* 典型命令：`rollup -c rollup.config.js`

---

## 3. 核心能力对比（简表）

| 特性                  |              tsup |        esbuild |                         rollup |
| ------------------- | ----------------: | -------------: | -----------------------------: |
| 速度                  |         ⭐⭐⭐⭐（非常快） |      ⭐⭐⭐⭐⭐（最快） |                          ⭐⭐（慢） |
| 输出格式 (cjs/esm/iife) |            支持（默认） |             支持 |                         支持（灵活） |
| 生成 .d.ts            | 内建（通过 dts 插件/tsc） | ❌（需 tsc 或额外工具） | 需额外工具（tsc + rollup-plugin-dts） |
| 插件生态                |     小（主要 wrapper） |            小/中 |                          大（成熟） |
| 配置复杂度               |                 低 |            低-中 |                              高 |
| 树摇（treeshake）       |      由 esbuild 决定 |              有 |                         好（按模块） |
| CommonJS 支持         |    有（via esbuild） |              有 |   需插件（@rollup/plugin-commonjs） |
| 适合场景                |         SDK / 工具库 |      超快构建、内部工具 |                      组件库、复杂兼容性 |

---

## 4. 深入解析：内部实现与行为差异

### a) 打包内核

* **tsup**：调用 `esbuild` 执行实际的 transpile + bundle，另外把常见的打包需求（dts、外部依赖处理、输出多格式）封装为默认行为或小插件逻辑。
* **esbuild**：自身实现全部打包流程（解析、转换、bundle、minify）。设计偏向成为“编译器/快速 bundler”。
* **rollup**：借助 JavaScript 实现模块解析、打包，通过插件实现诸多功能（如 CommonJS 转换、Tree-shaking 限定、替换、样式处理等）。

### b) 类型声明（.d.ts）

* tsup 通常集成 `tsc --emitDeclarationOnly` 或使用 `rollup-plugin-dts`（视配置而定）来生成类型声明；tsup 提供 `--dts` 参数。
* esbuild 不生成 `.d.ts`（需要配合 `tsc` 或 `api-extractor`）。
* rollup 本身不生成 `.d.ts`，常见做法是：`tsc --emitDeclarationOnly` + `rollup` 打包，或 `rollup-plugin-dts`。

### c) 外部依赖处理（external）

* tsup 默认会 externalize `dependencies`（不把它们打包进 bundle），这是库/SDK 的常见需求。
* esbuild/rollup 的默认行为需要手动配置 `external`。

### d) 插件与生态

* rollup 插件最成熟（例如处理 CSS、图片、CommonJS、Node 内置 polyfills 等）。
* esbuild 的插件系统正在发展，但主要优势体现在速度而非插件完备性。
* tsup 提供的是开箱即用体验，插件点较少，但通常满足库需求。

---

## 5. 典型使用场景与选型建议（更具体）

### 场景 A — 单入口 TypeScript 库/SDK（你的场景）

**推荐**：`tsup`
理由：

* 开箱即用：cjs/esm/d.ts 一条命令搞定
* 默认 external dependencies（避免把第三方打包进去）
* watch && fast incremental builds

### 场景 B — 性能敏感但愿意自管 d.ts（内部工具、CLI、快速测试包）

**推荐**：`esbuild`（或 tsup 也行）
理由：最快的构建速度，适合 CI 快速构建/测试。但需自己 run `tsc --emitDeclarationOnly`。

### 场景 C — UI 组件库 / 需要细粒度兼容性处理（IE/legacy bundle/UMD）

**推荐**：`rollup`
理由：强大的插件生态，方便对外部资源（CSS/图片）做精细化控制，同时对输出格式管理灵活（UMD、IIFE、named/anonymous globals）。

### 场景 D — Web 应用（SPA）

**推荐**：`Vite`（底层使用 `esbuild` 和 `rollup`）
说明：通常不直接选用 esbuild/rollup 做为最终应用 bundler，而是使用 Vite 这类工具来获得更完整体验。

---

## 6. 配置示例

### tsup（推荐的最简单配置）

```jsonc
// package.json scripts
"build": "tsup src/index.ts --format cjs,esm --dts --minify"
```

或者 `tsup.config.ts`:

```ts
import { defineConfig } from 'tsup'

export default defineConfig({
  entry: ['src/index.ts'],
  format: ['cjs', 'esm'],
  sourcemap: true,
  dts: true,
  clean: true,
  splitting: false, // 单入口通常 false
  watch: process.env.NODE_ENV === 'development',
})
```

### esbuild（基础示例 + 生成 d.ts 的常见组合）

```bash
# 需要同时运行 esbuild 和 tsc
esbuild src/index.ts --bundle --format=esm --outfile=dist/index.mjs --platform=node
# run tsc for types
tsc --emitDeclarationOnly --declaration --declarationDir dist/types
```

简单 node script 用法：

```js
// build.js
const esbuild = require('esbuild')
esbuild.build({
  entryPoints: ['src/index.ts'],
  bundle: true,
  platform: 'node',
  format: 'cjs',
  outfile: 'dist/index.cjs',
}).catch(() => process.exit(1))
```

### rollup（典型库配置，含 types 打包）

```js
// rollup.config.js
import resolve from '@rollup/plugin-node-resolve'
import commonjs from '@rollup/plugin-commonjs'
import typescript from '@rollup/plugin-typescript'
import dts from 'rollup-plugin-dts'

export default [
  {
    input: 'src/index.ts',
    external: id => /node_modules/.test(id),
    plugins: [resolve(), commonjs(), typescript({ tsconfig: './tsconfig.json' })],
    output: [
      { file: 'dist/index.esm.js', format: 'esm' },
      { file: 'dist/index.cjs.js', format: 'cjs' },
    ],
  },
  {
    input: 'dist/types/index.d.ts',
    plugins: [dts()],
    output: { file: 'dist/index.d.ts', format: 'es' },
  },
]
```

> 注：有时会先使用 `tsc --emitDeclarationOnly` 输出声明，然后用 `rollup-plugin-dts` 合并声明。

---

## 7. 实务注意点与性能调优

* **类型声明**：无论用哪种工具，`.d.ts` 通常还是靠 `tsc` 处理最稳妥（或者用 API Extractor 做更复杂的声明合并）。
* **external 设置**：库打包时将 `dependencies` 与 `peerDependencies` 标记为 external，避免把第三方包打入 bundle。tsup 默认这么做，但 rollup/esbuild 需要配置。
* **兼容性（target）**：esbuild/tsup 默认 target 通常 modern。需要兼容老环境时，务必设置 target 或增加 polyfills/compilation 步骤。
* **source map**：发布包时决定是否包含 source map（调试 vs 安全/体积权衡）。
* **bundle size 分析**：用 `source-map-explorer` 或 `rollup-plugin-visualizer` 查看产物体积。

---

## 8. 迁移与互操作指南

* **从 tsup -> rollup**：如果你现在用 tsup，想迁移到 rollup，通常是因为需要更复杂的插件或输出。迁移步骤：

  1. 添加 `rollup.config.js`，实现同样的 format/output。
  2. 把 tsup 的 `dts` 改为 `tsc --emitDeclarationOnly` 或 `rollup-plugin-dts`。
  3. 校验 external 列表（与 package.json 的 dependencies/peerDependencies 对齐）。

* **从 rollup -> tsup**：如果你不需要复杂插件，想要更快的构建并减少配置量，直接用 tsup 替换 rollup，注意：

  1. 确认你用到的 rollup 插件是否必要（例如样式/资源处理）。
  2. 将 types 生成迁移为 tsup 的 `--dts` 或保留 `tsc --emitDeclarationOnly`。

---

## 9. 常见问答（FAQ）

**Q1：为什么 esbuild 不生成 .d.ts？**
A：esbuild 的目标是 "编译/打包"，而不是类型系统。TypeScript 的类型检查与声明文件生成仍由 `tsc` 负责（或者用专门工具）。

**Q2：tsup 还需要 tsc 吗？**
A：为了类型检查，CI 推荐仍然运行 `tsc --noEmit`。tsup 的 `--dts` 会触发声明文件生成（内部可能调用 tsc 或其他策略），但类型检查你应该单独做。

**Q3：性能重要还是可配置重要？**
A：权衡取决于项目。工具链越简单，构建越快；可配置性越高，能处理的特殊场景越多。库/SDK 常优先简洁与发布稳定性，应用则更偏向开发体验与热重载速度。

---

## 10. 推荐的实践模板（Library / SDK）

* `package.json` scripts：

```json
{
  "scripts": {
    "build": "tsup",
    "build:watch": "tsup --watch",
    "typecheck": "tsc --noEmit"
  }
}
```

* CI：运行 `pnpm run typecheck` -> `pnpm run build` -> 发布。
* 保证 `peerDependencies` 与 `dependencies` 区分清楚：将用户应该提供的（例如 react）放入 `peerDependencies`。


# classroom-bridge
---

## ğŸ’¡ ä¸€å¥è¯æ€»ç»“

`classroom-bridge` è¿™ä¸ªåŒ…åœ¨è¿™æ®µä»£ç ä¸­æ‰¿æ‹…çš„æ ¸å¿ƒè§’è‰²æ˜¯ï¼š

> ä¸€ä¸ª **è·¨ iframe / WebView é€šä¿¡å±‚ï¼ˆJSON-RPC å®¢æˆ·ç«¯é€šä¿¡æ¡¥ï¼‰**ã€‚
> å®ƒå°è£…äº† **ä¸»é¡µé¢ä¸ iframeï¼ˆæ’­æ”¾å™¨ï¼‰ä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’ã€æ–¹æ³•æ³¨å†Œã€äº‹ä»¶å›è°ƒæœºåˆ¶**ã€‚

---

## ğŸ§© æˆ‘ä»¬ä» `Player` ç±»çš„ä½¿ç”¨è§’åº¦çœ‹ï¼š

### 1ï¸âƒ£ `Player.client = bridge.RPCBridge.get(this.getContentId())`

è¿™è¯´æ˜ï¼š

* `RPCBridge` æ˜¯ä¸€ä¸ª**ç®¡ç†é€šä¿¡å®ä¾‹çš„å•ä¾‹å·¥å‚**ã€‚
* `.get(id)` ä¼šè¿”å›ä¸€ä¸ª **JsonRPCClient** å®ä¾‹ã€‚
* æ¯ä¸ª `iframe`ï¼ˆå³æ’­æ”¾å™¨ï¼‰éƒ½ç”¨ä¸€ä¸ªå”¯ä¸€çš„ ID (`res_code` / `version`) æ¥æ ‡è¯†é€šä¿¡å¯¹è±¡ã€‚

---

### 2ï¸âƒ£ `Player.addMethod = Player.client.addMethod`

è¿™è¯´æ˜ï¼š

* `JsonRPCClient` å®ä¾‹å…·å¤‡ `addMethod(name, handler)` æ–¹æ³•ã€‚
* å®ƒè´Ÿè´£æ³¨å†Œ **è¿œç¨‹å¯è°ƒç”¨çš„æ–¹æ³•**ï¼Œä¾›å¦ä¸€ç«¯ï¼ˆiframeï¼‰è°ƒç”¨ã€‚

> ä¾‹å¦‚ iframe å†…æ‰§è¡Œ `rpc.call('download')`ï¼Œå°±ä¼šè§¦å‘å®¿ä¸»ç«¯è¿™é‡Œæ³¨å†Œçš„ `addMethod('download', handler)`ã€‚

---

### 3ï¸âƒ£ `this.receiver = bridge.createClientReceiver(Player.client)`

è¿™è¯´æ˜ï¼š

* `createClientReceiver(client)` ç”¨äºç”Ÿæˆä¸€ä¸ª `message` äº‹ä»¶ç›‘å¬å™¨å‡½æ•°ã€‚
* å®ƒæ¥æ”¶æ¥è‡ª iframe çš„ `postMessage` æ¶ˆæ¯ï¼Œç„¶ååˆ†å‘ç»™å¯¹åº”çš„ `JsonRPCClient` å®ä¾‹å¤„ç†ã€‚

---

### 4ï¸âƒ£ `Player.client.send = bridge.createClientSender(this.getContentId(), this.ref)`

è¿™è¯´æ˜ï¼š

* `createClientSender()` è¿”å›ä¸€ä¸ªå‘é€å‡½æ•°ã€‚
* å†…éƒ¨åº”å½“æ˜¯ï¼š

  ```js
  function createClientSender(id, iframeRef) {
    return (message) => iframeRef.contentWindow.postMessage(message, '*')
  }
  ```
* ä¹Ÿå°±æ˜¯æŠŠ JSON-RPC çš„è¯·æ±‚åºåˆ—åŒ–åå‘ç»™ iframeã€‚

---

### 5ï¸âƒ£ `Player.client.request(name, ...args)`

åœ¨ `AddClientMethods` é‡Œæœ‰ï¼š

```js
player.prototype[name] = (...arg) => Player.client.request(name, ...arg)
```

è¯´æ˜ `JsonRPCClient` è¿˜å°è£…äº†ä¸€ä¸ªæ ‡å‡†çš„è¿œç¨‹è°ƒç”¨æ¥å£ï¼ˆç¬¦åˆ JSON-RPC è§„èŒƒï¼‰ï¼š

* è°ƒç”¨ `request('methodName', params...)` ä¼šå‘é€ JSONï¼š

  ```json
  {
    "jsonrpc": "2.0",
    "method": "methodName",
    "params": [...],
    "id": 1
  }
  ```
* å¯¹æ–¹ï¼ˆiframe å†…çš„ JSï¼‰æ”¶åˆ°åæ‰§è¡Œå®é™…é€»è¾‘ï¼Œç„¶å `postMessage` å›ç»“æœã€‚

---

## ğŸš€ ç»¼åˆèŒè´£æ€»ç»“

| æ¨¡å—                       | ä½œç”¨                                                       |
| ------------------------ | -------------------------------------------------------- |
| **RPCBridge**            | ç®¡ç†æ‰€æœ‰ RPC å®¢æˆ·ç«¯å®ä¾‹ï¼ˆæŒ‰ ID ç¼“å­˜ï¼‰                                  |
| **JsonRPCClient**        | å°è£…ä¸€ä¸ªå…·ä½“çš„ JSON-RPC å®¢æˆ·ç«¯ï¼Œæ”¯æŒ `request`ã€`on`ã€`off`ã€`addMethod` |
| **createClientReceiver** | ç”Ÿæˆæ¶ˆæ¯æ¥æ”¶å‡½æ•°ï¼ˆç›‘å¬ `window.postMessage`ï¼‰                        |
| **createClientSender**   | ç”Ÿæˆæ¶ˆæ¯å‘é€å‡½æ•°ï¼ˆå‘ iframe å‘é€ JSON-RPC æ¶ˆæ¯ï¼‰                        |
| **é€šä¿¡åè®®**                 | é€šè¿‡ `window.postMessage` å®ç°ä¸»é¡µé¢ä¸ iframe åŒå‘é€šä¿¡               |
| **äº‹ä»¶ç³»ç»Ÿ**                 | æ”¯æŒ `on`ã€`off` æ³¨å†Œäº‹ä»¶ç›‘å¬                                     |
| **è¿œç¨‹è°ƒç”¨**                 | æ”¯æŒè·¨ç¯å¢ƒè°ƒç”¨æ–¹æ³• (`request` + `addMethod`)                      |

---

## ğŸ§  å¦‚æœä½ è¦è‡ªå·±å¼€å‘ `classroom-bridge`ï¼Œå¤§è‡´ç»“æ„å¯ä»¥è¿™æ ·ï¼š

### ğŸ§± ç›®å½•ç»“æ„å»ºè®®

```
@/classroom-bridge/
â”œâ”€ index.ts
â”œâ”€ rpc/
â”‚  â”œâ”€ RPCBridge.ts
â”‚  â”œâ”€ JsonRPCClient.ts
â”‚  â”œâ”€ createClientReceiver.ts
â”‚  â”œâ”€ createClientSender.ts
â”‚  â””â”€ types.ts
```

---

### ğŸ”§ å…³é”®æ¨¡å—è®¾è®¡

#### 1ï¸âƒ£ RPCBridge.ts

```ts
import { JsonRPCClient } from './JsonRPCClient'

class RPCBridge {
  private static instances = new Map<string, JsonRPCClient>()

  static get(id: string) {
    if (!this.instances.has(id)) {
      this.instances.set(id, new JsonRPCClient(id))
    }
    return this.instances.get(id)!
  }
}

export const RPCBridgeInstance = RPCBridge
```

---

#### 2ï¸âƒ£ JsonRPCClient.ts

```ts
export class JsonRPCClient {
  id: string
  private methods = new Map<string, Function>()
  private listeners = new Map<string, Set<Function>>()
  send: (msg: any) => void = () => {}

  constructor(id: string) {
    this.id = id
  }

  request(method: string, ...args: any[]) {
    const message = {
      jsonrpc: '2.0',
      id: Date.now(),
      method,
      params: args,
    }
    this.send(message)
  }

  addMethod(name: string, fn: Function) {
    this.methods.set(name, fn)
  }

  handleMessage(msg: any) {
    if (msg.method && this.methods.has(msg.method)) {
      this.methods.get(msg.method)!(...msg.params)
    }
  }

  on(event: string, cb: Function) {
    if (!this.listeners.has(event)) this.listeners.set(event, new Set())
    this.listeners.get(event)!.add(cb)
  }

  off(event: string, cb: Function) {
    this.listeners.get(event)?.delete(cb)
  }

  emit(event: string, data: any) {
    this.listeners.get(event)?.forEach(cb => cb(data))
  }

  ready() {
    console.log(`[bridge:${this.id}] ready`)
  }
}
```

---

#### 3ï¸âƒ£ createClientSender.ts

```ts
export function createClientSender(id: string, iframe: HTMLIFrameElement | null) {
  return (msg: any) => {
    iframe?.contentWindow?.postMessage({ source: id, ...msg }, '*')
  }
}
```

---

#### 4ï¸âƒ£ createClientReceiver.ts

```ts
export function createClientReceiver(client: any) {
  return (event: MessageEvent) => {
    if (event.data?.jsonrpc === '2.0') {
      client.handleMessage(event.data)
    }
  }
}
```

---

### âœ… æ€»ç»“ä¸€å¥ï¼š

`classroom-bridge` æœ¬è´¨æ˜¯ï¼š

> ä¸€ä¸ªåŸºäº **window.postMessage + JSON-RPC åè®®** çš„é€šä¿¡æ¡¥ï¼Œ
> ç”¨æ¥è®© â€œå¤–éƒ¨å®¹å™¨ï¼ˆä¸»é¡µé¢ï¼‰â€ ä¸ â€œå†…éƒ¨æ’­æ”¾å™¨ï¼ˆiframeï¼‰â€ äº’ç›¸è°ƒç”¨æ–¹æ³•ã€æ´¾å‘äº‹ä»¶ã€å…±äº«çŠ¶æ€ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼š

* ğŸš§ ä¸€æ­¥æ­¥æ­å»ºä¸€ä¸ªå®Œæ•´çš„ `classroom-bridge` åŒ…ï¼ˆå«ç±»å‹å£°æ˜ã€ç›‘å¬ä¸æ¸…ç†ï¼‰
* ğŸ§  å¹¶å®ç° iframe â†” parent çš„å®é™…é€šä¿¡ demoï¼ˆå¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨è¿è¡ŒéªŒè¯ï¼‰

è¦æˆ‘å¸®ä½ å†™è¿™ä¸ªæœ€ç®€å¯è¿è¡Œç‰ˆï¼ˆiframe â†” é¡µé¢äº’è°ƒï¼‰å—ï¼Ÿ


éå¸¸å¥½ ğŸ‘ æˆ‘æ¥è¯¦ç»†æ‹†è§£ä¸‹ï¼Œå¸®ä½ æ˜ç¡®ï¼š
**`classroom-bridge` è¿™ä¸ªåŒ…çš„èŒè´£æ˜¯ä»€ä¹ˆã€Player æ˜¯æ€ä¹ˆç”¨å®ƒçš„ã€å¦‚æœè¦è‡ªå·±å¼€å‘è¿™ä¸ª bridgeï¼Œåº”è¯¥æ€ä¹ˆåšã€‚**

---

## ğŸ§© ä¸€ã€ä»ç°æœ‰ä»£ç åæ¨ bridge çš„èŒè´£

Player é‡Œç”¨åˆ°çš„ bridge æœ‰è¿™äº›å…³é”®ç‚¹ ğŸ‘‡

```ts
import * as bridge from 'classroom-bridge'
```

ç„¶åç”¨åˆ°çš„æ–¹æ³•æœ‰ï¼š

```ts
bridge.RPCBridge.get(...)
bridge.createClientReceiver(...)
bridge.createClientSender(...)
```

å†çœ‹ Player çš„é€»è¾‘ï¼š

1. **åˆ›å»º JSON RPC é€šä¿¡å®ä¾‹**

   ```ts
   Player.client = bridge.RPCBridge.get(this.getContentId())
   Player.addMethod = Player.client.addMethod
   ```

   ğŸ‘‰ è¯´æ˜ `bridge.RPCBridge` æ˜¯ä¸€ä¸ª **ç®¡ç†å¤šå®¢æˆ·ç«¯çš„å•ä¾‹å·¥å‚**ï¼Œ
   é€šè¿‡ `get(id)` è·å–ä¸€ä¸ª JSON-RPC å®¢æˆ·ç«¯å®ä¾‹ã€‚

2. **ç»‘å®šé€šä¿¡é€šé“**

   ```ts
   this.receiver = bridge.createClientReceiver(Player.client)
   Player.client.send = bridge.createClientSender(this.getContentId(), this.ref)
   ```

   ğŸ‘‰ è¯´æ˜ï¼š

   * `createClientReceiver()` è¿”å›ä¸€ä¸ª `window.addEventListener('message', handler)` å¤„ç†å‡½æ•°ï¼›
   * `createClientSender()` è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥é€šè¿‡ `postMessage` ç»™ iframe å‘æ¶ˆæ¯ï¼›
   * ä¸¤è€…ç»„åˆå®ç°äº†çˆ¶é¡µé¢ä¸ iframe ä¹‹é—´çš„ **åŒå‘é€šä¿¡**ã€‚

3. **Player.client çš„è¡Œä¸º**

   * `Player.client.addMethod('download', fn)`ï¼šæ³¨å†ŒæœåŠ¡ç«¯æ–¹æ³•ï¼›
   * `Player.client.request('play', data)`ï¼šè¯·æ±‚è¿œç«¯è°ƒç”¨ï¼›
   * `Player.client.on('loaded', fn)`ï¼šç›‘å¬è¿œç«¯äº‹ä»¶ï¼›
   * `Player.client.ready()`ï¼šé€šçŸ¥è¿œç«¯å¯ä»¥é€šä¿¡ï¼›
   * `Player.client.send`ï¼šå‘é€ JSON-RPC æ¶ˆæ¯ã€‚

   ğŸ‘‰ æ‰€ä»¥ `Player.client` æ˜¯ä¸€ä¸ª **JSON-RPC å®¢æˆ·ç«¯å¯¹è±¡**ï¼ŒåŒ…å«è¯·æ±‚ã€äº‹ä»¶ç›‘å¬ã€æ¶ˆæ¯æ³¨å†Œã€å‘é€èƒ½åŠ›ã€‚

---

## ğŸ§­ äºŒã€èŒè´£æ€»ç»“

`classroom-bridge` çš„èŒè´£å¤§æ¦‚æ˜¯ï¼š

| æ¨¡å—                       | èŒè´£                                                           |
| ------------------------ | ------------------------------------------------------------ |
| `RPCBridge`              | ç®¡ç†æ‰€æœ‰ RPC å®¢æˆ·ç«¯å®ä¾‹ï¼ˆæŒ‰å†…å®¹ ID åŒºåˆ†ï¼‰ï¼Œæ”¯æŒ `.get()` è·å–ã€ç¼“å­˜å®ä¾‹ã€‚               |
| `JsonRPCClient`          | ç»´æŠ¤æœ¬åœ°æ–¹æ³•æ³¨å†Œè¡¨ã€äº‹ä»¶ç³»ç»Ÿã€è¯·æ±‚å›è°ƒæ˜ å°„ã€‚å°è£… `request`ã€`on`ã€`off`ã€`addMethod` ç­‰ã€‚ |
| `createClientReceiver()` | è¿”å›ç”¨äºæ¥æ”¶ `postMessage` æ¶ˆæ¯å¹¶åˆ†å‘åˆ° JsonRPCClient çš„ç›‘å¬å‡½æ•°ã€‚             |
| `createClientSender()`   | è¿”å›ç”¨äºé€šè¿‡ `postMessage` å‘æŒ‡å®š iframe å‘é€æ¶ˆæ¯çš„å‡½æ•°ã€‚                     |
| `bridge` é¡¶å±‚å¯¼å‡º            | æä¾›è·¨ iframe çš„åŒå‘é€šä¿¡æ¡¥ï¼Œå…¼å®¹ Webã€Native ç­‰ä¸åŒè¿è¡Œç¯å¢ƒã€‚                     |

---

## âš™ï¸ ä¸‰ã€å¦‚æœè¦è‡ªå·±å¼€å‘ `classroom-bridge`

ä½ å¯ä»¥ä»æœ€å°å®ç°å¼€å§‹ğŸ‘‡

### 1. å®šä¹‰ä¸€ä¸ªç®€å•çš„ JsonRPCClient ç±»

```ts
// bridge/JsonRPCClient.ts
export class JsonRPCClient {
  private methods = new Map<string, Function>()
  private pending = new Map<string, Function>()
  private eventHandlers = new Map<string, Set<Function>>()

  constructor(public id: string) {}

  addMethod(name: string, handler: Function) {
    this.methods.set(name, handler)
  }

  on(event: string, handler: Function) {
    if (!this.eventHandlers.has(event)) this.eventHandlers.set(event, new Set())
    this.eventHandlers.get(event)!.add(handler)
  }

  off(event: string, handler: Function) {
    this.eventHandlers.get(event)?.delete(handler)
  }

  emit(event: string, data: any) {
    this.eventHandlers.get(event)?.forEach(fn => fn(data))
  }

  async request(method: string, ...params: any[]) {
    const id = Math.random().toString(36).slice(2)
    return new Promise((resolve) => {
      this.pending.set(id, resolve)
      this.send?.({ jsonrpc: '2.0', id, method, params })
    })
  }

  handleMessage(message: any) {
    const { id, method, result, params } = message

    if (result && this.pending.has(id)) {
      this.pending.get(id)!(result)
      this.pending.delete(id)
    } else if (method && this.methods.has(method)) {
      const result = this.methods.get(method)!(...params)
      this.send?.({ jsonrpc: '2.0', id, result })
    } else if (method === 'event') {
      this.emit(params.name, params.data)
    }
  }

  send?: (data: any) => void
}
```

---

### 2. å®ç° createClientReceiver / Sender

```ts
export function createClientReceiver(client: JsonRPCClient) {
  return (event: MessageEvent) => {
    if (!event.data || !event.data.jsonrpc) return
    client.handleMessage(event.data)
  }
}

export function createClientSender(targetId: string, iframe?: HTMLIFrameElement) {
  return (data: any) => {
    iframe?.contentWindow?.postMessage(data, '*')
  }
}
```

---

### 3. ç®¡ç†å¤šä¸ªå®¢æˆ·ç«¯å®ä¾‹

```ts
export class RPCBridge {
  private static clients = new Map<string, JsonRPCClient>()

  static get(id: string) {
    if (!this.clients.has(id)) {
      this.clients.set(id, new JsonRPCClient(id))
    }
    return this.clients.get(id)!
  }
}
```

---

### 4. å¯¼å‡ºç»Ÿä¸€æ¥å£

```ts
// index.ts
export * from './JsonRPCClient'
export { RPCBridge } from './RPCBridge'
export { createClientReceiver, createClientSender } from './helpers'
```

---

## ğŸ§  å››ã€æ€»ç»“ä¸€ä¸‹æ€è·¯

`classroom-bridge` å…¶å®æ˜¯ä¸€ä¸ªï¼š

> **åŸºäº postMessage å®ç°çš„ iframe åŒå‘ JSON-RPC é€šä¿¡å±‚**

* Playerï¼ˆçˆ¶é¡µé¢ï¼‰é€šè¿‡å®ƒæ§åˆ¶ iframe æ’­æ”¾å™¨ï¼›
* iframe å†…éƒ¨çš„æ’­æ”¾å™¨ SDKï¼ˆå¦ä¸€ç«¯ï¼‰åŒæ ·ä¼šä½¿ç”¨ `bridge`ï¼›
* åŒæ–¹éƒ½å¯ä»¥ï¼š

  * è°ƒç”¨è¿œç«¯æ–¹æ³•ï¼ˆrequestï¼‰
  * å“åº”è¿œç«¯è¯·æ±‚ï¼ˆaddMethodï¼‰
  * ç›‘å¬äº‹ä»¶ï¼ˆon / offï¼‰

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼š
âœ… ç›´æ¥æ­ä¸€ä¸ªå®Œæ•´çš„æœ€å°å¯è¿è¡Œç‰ˆ `classroom-bridge`
âœ… æ”¯æŒçˆ¶å­ iframe é€šä¿¡ + JSON-RPC è°ƒç”¨
âœ… å¯æœ¬åœ°è°ƒè¯•

æ˜¯å¦è¦æˆ‘å¸®ä½ ç”Ÿæˆè¿™ä»½å¯è¿è¡Œçš„ç®€ç‰ˆå®ç°ï¼Ÿ

å¥½çš„ âœ…
æˆ‘ä¼šç»™ä½ ä¸€ä¸ª**å®Œæ•´çš„å¯è¿è¡Œ Demo æ¨¡æ¿ï¼ˆåŸºäº Vite + TypeScriptï¼‰**ï¼ŒåŒ…å«ï¼š

âœ… çˆ¶é¡µé¢ï¼šä½¿ç”¨æ¡¥è°ƒç”¨ iframe
âœ… iframe é¡µé¢ï¼šå®ç° JSON-RPC æ–¹æ³•ã€äº‹ä»¶
âœ… ä½ çš„è¿·ä½ ç‰ˆæœ¬ `classroom-bridge`
âœ… ç›´æ¥ `npm install` â†’ `npm run dev` å°±èƒ½çœ‹åˆ° iframe é€šä¿¡æ•ˆæœ

---

# âœ… ç›®å½•ç»“æ„ï¼ˆå¤åˆ¶å³å¯ï¼‰

```
my-bridge-demo/
â”‚
â”œâ”€ package.json
â”œâ”€ vite.config.ts
â”œâ”€ index.html
â”‚
â”œâ”€ src/
â”‚  â”œâ”€ main.ts           # çˆ¶é¡µé¢
â”‚  â”œâ”€ iframe.html       # iframe é¡µé¢
â”‚  â”œâ”€ iframe.ts         # iframe é€»è¾‘
â”‚  â”‚
â”‚  â””â”€ bridge/           # ä½ è¦çš„ classroom-bridge ç®€åŒ–å®ç°
â”‚      â”œâ”€ index.ts
â”‚      â”œâ”€ JsonRPCClient.ts
â”‚      â”œâ”€ RPCBridge.ts
â”‚      â”œâ”€ helpers.ts
```

---

# âœ… package.json

```json
{
  "name": "my-bridge-demo",
  "version": "1.0.0",
  "scripts": {
    "dev": "vite",
    "build": "vite build"
  },
  "devDependencies": {
    "typescript": "^5.0.0",
    "vite": "^5.0.0"
  }
}
```

---

# âœ… vite.config.ts

```ts
import { defineConfig } from "vite";

export default defineConfig({
  server: {
    host: true,
    port: 3000,
  }
});
```

---

# âœ… index.htmlï¼ˆçˆ¶é¡µé¢ï¼‰

```html
<!DOCTYPE html>
<html lang="en">
  <body>
    <h1>Parent Page</h1>

    <button id="call">è°ƒç”¨ iframe æ–¹æ³•</button>

    <iframe
      src="/src/iframe.html"
      id="my-iframe"
      width="600"
      height="400"
      style="border:1px solid #aaa;"
    ></iframe>

    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
```

---

# âœ… src/main.tsï¼ˆçˆ¶é¡µé¢é€»è¾‘ï¼‰

```ts
import * as bridge from "./bridge";

const iframe = document.getElementById("my-iframe") as HTMLIFrameElement;

// åˆ›å»º RPC å®¢æˆ·ç«¯
const client = bridge.RPCBridge.get("demo");

client.send = bridge.createClientSender("demo", iframe);
const receiver = bridge.createClientReceiver(client);
window.addEventListener("message", receiver);

client.ready();

console.log("[Parent] RPC Ready");

// ç›‘å¬ iframe äº‹ä»¶
client.on("loaded", (msg) => {
  console.log("[Parent] æ”¶åˆ° iframe loaded:", msg);
});

// ç‚¹å‡»æŒ‰é’® â†’ è°ƒç”¨ iframe æ–¹æ³•
document.getElementById("call")!.onclick = async () => {
  const result = await client.request("sayHello", "ChatGPT");
  console.log("[Parent] è°ƒç”¨ iframe æ–¹æ³•è¿”å›:", result);
};
```

---

# âœ… src/iframe.htmlï¼ˆiframe é¡µé¢ï¼‰

```html
<!DOCTYPE html>
<html lang="en">
  <body>
    <h2>Iframe Page</h2>

    <script type="module" src="./iframe.ts"></script>
  </body>
</html>
```

---

# âœ… src/iframe.tsï¼ˆå­é¡µé¢é€»è¾‘ï¼‰

```ts
import * as bridge from "./bridge";

// åˆ›å»º RPC å®¢æˆ·ç«¯
const client = bridge.RPCBridge.get("demo");

client.send = (msg) => window.parent.postMessage(msg, "*");

const receiver = bridge.createClientReceiver(client);
window.addEventListener("message", receiver);

client.ready();

console.log("[Iframe] RPC Ready");

// æš´éœ²æ–¹æ³•ç»™çˆ¶é¡µé¢è°ƒç”¨
client.addMethod("sayHello", (name: string) => {
  console.log("[Iframe] sayHello è¢«çˆ¶é¡µé¢è°ƒç”¨:", name);
  return `ä½ å¥½ï¼Œ${name}`;
});

// é€šçŸ¥çˆ¶é¡µé¢ï¼šæˆ‘åŠ è½½å¥½äº†
setTimeout(() => {
  client.emit("loaded", { msg: "Iframe å·²åŠ è½½å®Œæˆ âœ…" });
}, 500);
```

---

# âœ… src/bridge/JsonRPCClient.ts

```ts
export interface JsonRPCMessage {
  jsonrpc: "2.0";
  id?: string;
  method?: string;
  params?: any;
  result?: any;
}

export class JsonRPCClient {
  id: string;
  send?: (msg: JsonRPCMessage) => void;

  private pending = new Map<string, (res: any) => void>();
  private methods = new Map<string, Function>();
  private eventHandlers = new Map<string, Set<Function>>();

  constructor(id: string) {
    this.id = id;
  }

  addMethod(name: string, fn: Function) {
    this.methods.set(name, fn);
  }

  request(method: string, ...params: any[]) {
    const id = Math.random().toString(36).slice(2);
    const message: JsonRPCMessage = {
      jsonrpc: "2.0",
      id,
      method,
      params,
    };
    return new Promise((resolve) => {
      this.pending.set(id, resolve);
      this.send?.(message);
    });
  }

  on(event: string, handler: Function) {
    if (!this.eventHandlers.has(event)) {
      this.eventHandlers.set(event, new Set());
    }
    this.eventHandlers.get(event)!.add(handler);
  }

  emit(event: string, data: any) {
    this.send?.({
      jsonrpc: "2.0",
      method: "event",
      params: { name: event, data },
    });
  }

  handleMessage(msg: JsonRPCMessage) {
    if (msg.result && msg.id && this.pending.has(msg.id)) {
      this.pending.get(msg.id)!(msg.result);
      this.pending.delete(msg.id);
      return;
    }

    if (msg.method === "event") {
      const { name, data } = msg.params;
      this.eventHandlers.get(name)?.forEach((fn) => fn(data));
      return;
    }

    if (msg.method && this.methods.has(msg.method)) {
      const res = this.methods.get(msg.method)!(...(msg.params || []));
      if (msg.id) {
        this.send?.({ jsonrpc: "2.0", id: msg.id, result: res });
      }
    }
  }

  ready() {
    console.log(`[JsonRPCClient:${this.id}] Ready`);
  }
}
```

---

# âœ… src/bridge/helpers.ts

```ts
import { JsonRPCClient } from "./JsonRPCClient";

export function createClientReceiver(client: JsonRPCClient) {
  return (event: MessageEvent) => {
    if (!event.data || event.data.jsonrpc !== "2.0") return;
    client.handleMessage(event.data);
  };
}

export function createClientSender(id: string, iframe: HTMLIFrameElement) {
  return (msg: any) => {
    iframe?.contentWindow?.postMessage(msg, "*");
  };
}
```

---

# âœ… src/bridge/RPCBridge.ts

```ts
import { JsonRPCClient } from "./JsonRPCClient";

export class RPCBridge {
  private static clients = new Map<string, JsonRPCClient>();

  static get(id: string) {
    if (!this.clients.has(id)) {
      this.clients.set(id, new JsonRPCClient(id));
    }
    return this.clients.get(id)!;
  }
}
```

---

# âœ… src/bridge/index.ts

```ts
export * from "./JsonRPCClient";
export * from "./helpers";
export * from "./RPCBridge";
```

---

# âœ… ä½¿ç”¨æ–¹å¼

```bash
npm install
npm run dev
```

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š

ğŸ‘‰ [http://localhost:3000](http://localhost:3000)

ä½ å°†çœ‹åˆ°ï¼š

âœ… iframe ç»™çˆ¶é¡µé¢å‘é€ loaded äº‹ä»¶
âœ… çˆ¶é¡µé¢ç‚¹å‡»æŒ‰é’® â†’ è°ƒç”¨ iframe æ–¹æ³•
âœ… iframe è¿”å›å­—ç¬¦ä¸² â€œä½ å¥½ï¼ŒChatGPTâ€

**å®Œæ•´çš„ JSON-RPC åŒå‘é€šä¿¡æˆåŠŸ âœ…**

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘è¿˜å¯ä»¥ç»§ç»­å¸®åŠ©ä½ ï¼š
âœ… åŠ å…¥è¶…æ—¶æœºåˆ¶ï¼ˆrequest è¶…æ—¶ï¼‰
âœ… åŠ å…¥é˜Ÿåˆ— / æ‰¹é‡è°ƒç”¨
âœ… åŠ å…¥ NativeBridge é€‚é…ï¼ˆApp WebViewï¼‰
âœ… åŠ å…¥äº‹ä»¶æ—¥å¿— / è°ƒè¯•å·¥å…·
âœ… å®Œæ•´æ¨¡æ‹Ÿ classroom-bridge çš„èƒ½åŠ›

éœ€è¦ç»§ç»­æ‰©å±•åŠŸèƒ½å—ï¼Ÿ

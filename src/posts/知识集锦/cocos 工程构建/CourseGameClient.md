

# CourseGameClientï¼ˆGame-SDKï¼‰

## 1. è®¾è®¡èƒŒæ™¯ä¸ç›®æ ‡

`CourseGameClient` æ˜¯ Course äº’åŠ¨è¯¾ä»¶ä½“ç³»çš„**å‰ç«¯æ¸¸æˆè¿è¡Œ SDK**ã€‚å®ƒçš„ç›®æ ‡æ˜¯ï¼š

1. **ç»Ÿä¸€æ¸¸æˆçš„çŠ¶æ€ç®¡ç†æœºåˆ¶**ï¼ˆstate + propsï¼‰ã€‚
2. **è§„èŒƒå®¿ä¸»ç«¯ä¸æ¸¸æˆçš„åŒå‘é€šä¿¡åè®®**ï¼ˆEventEmitter æ¶ˆæ¯äº‹ä»¶ï¼‰ã€‚
3. **æä¾›å¯æ§æ¸²æŸ“å‘¨æœŸ**ï¼ˆrender â†’ useEffectï¼‰ã€‚
4. **æä¾›æ¸¸æˆå¸¸ç”¨èƒ½åŠ›çš„å°è£…**ï¼ˆé™éŸ³ã€æµ‹è¯„ã€å¤–éƒ¨æ§åˆ¶ã€ç¼–è¾‘æ¨¡å¼ç­‰ï¼‰ã€‚
5. **è®©æ¸¸æˆå¼€å‘è€…â€œåªå†™é€»è¾‘ï¼Œä¸å…³å¿ƒç¯å¢ƒå·®å¼‚â€**ï¼Œä½¿æ¸¸æˆå¯ä»¥æ— ç¼è¿è¡Œäºï¼šè€å¸ˆç«¯ã€å­¦ç”Ÿç«¯ã€é¢„è§ˆå™¨ã€ç¼–è¾‘å™¨ç­‰ä¸åŒå®¢æˆ·ç«¯ã€‚

ä»æœ¬è´¨ä¸Šè®²ï¼Œå®ƒæ˜¯ä¸€ä¸ª**è½»é‡ç‰ˆ React è¿è¡Œæ—¶ + æ¶ˆæ¯æ¡¥æ¥å±‚ + æ¸¸æˆç”Ÿå‘½å‘¨æœŸè°ƒåº¦å™¨**ã€‚

---

## 2. SDK æ‰®æ¼”çš„è§’è‰²ï¼ˆèŒèƒ½ï¼‰

### âœ” 2.1 æ¸¸æˆçš„è¿è¡Œå®¹å™¨ Runtime

å®ƒç®¡ç†ï¼š

* æ¸¸æˆçš„â€œå†…éƒ¨çŠ¶æ€â€ `state`
* å®¿ä¸»ä¼ å…¥çš„â€œå¤–éƒ¨å±æ€§â€ `props`
* çŠ¶æ€å˜åŒ–è§¦å‘æ¸²æŸ“ `render()`
* render å†…éƒ¨æ‰§è¡Œâ€œå‰¯ä½œç”¨â€ `useEffect()`

ç±»ä¼¼ Reactï¼Œä½†æ›´è½»ã€æ›´å¯æ§ï¼Œé€‚åˆåµŒå…¥å¼å°æ¸¸æˆã€‚

---

### âœ” 2.2 Hostï¼ˆå®¿ä¸»ç«¯ï¼‰ä¸æ¸¸æˆä¹‹é—´çš„é€šä¿¡æ¡¥

é€šè¿‡ç»§æ‰¿ `EventEmitter`ï¼Œsdk æä¾›è§„èŒƒäº‹ä»¶ï¼š

å®¿ä¸» â†’ æ¸¸æˆï¼š

| äº‹ä»¶å                 | å«ä¹‰             |
| ------------------- | -------------- |
| pullState           | ä¸»åŠ¨ä¸‹å‘ state ç»™æ¸¸æˆ |
| pullProps           | ä¸‹å‘ props       |
| mute                | æ§åˆ¶æ¸¸æˆé™éŸ³         |
| beginSpeechEvaluation   | å¼€å§‹è¯­éŸ³æµ‹è¯„         |
| onSpeechEvaluationResult | å›ä¼ æµ‹è¯„ç»“æœ         |
| onSpeechEvaluationError    | æµ‹è¯„å¤±è´¥           |

æ¸¸æˆ â†’ å®¿ä¸»ï¼š

| äº‹ä»¶å                      | å«ä¹‰                   |
| ------------------------ | -------------------- |
| pushState                | æ¸¸æˆå‘Šè¯‰å®¿ä¸»â€œæˆ‘çš„ state æ›´æ–°äº†â€ |
| pushProps                | æ¸¸æˆè¯·æ±‚å®¿ä¸»æ›´æ–° props       |
| beginSpeechEvaluation_action | æ¸¸æˆè¯·æ±‚å®¿ä¸»å¼€å§‹æµ‹è¯„           |
| stopSpeakingTest_action  | æ¸¸æˆè¯·æ±‚å®¿ä¸»åœæ­¢æµ‹è¯„           |

**ç»“è®º**ï¼šSDK æ˜¯æ¸¸æˆä¸å®¿ä¸»ä¹‹é—´çš„â€œåè®®å±‚â€ã€‚

---

### âœ” 2.3 å†…ç½®æ¸¸æˆå¸¸ç”¨èƒ½åŠ›

SDK å†…ç½®ï¼š

* ğŸ”Š é™éŸ³ onMute(callback)
* ğŸ¤ å£è¯­æµ‹è¯„ beginSpeechEvaluation / stopSpeakingTest
* ğŸ›  ç¼–è¾‘æ¨¡å¼ isEdit
* ğŸ”„ åŒæ­¥æ¸²æŸ“ sync()

è¿™äº›èƒ½åŠ›å±è”½äº†è·¨ç«¯å·®å¼‚ï¼Œä½¿æ¸¸æˆåœ¨ä»»ä½•è¿è¡Œç¯å¢ƒéƒ½èƒ½è¡¨ç°ä¸€è‡´ã€‚

---

### âœ” 2.4 æ¸¸æˆç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆç±»ä¼¼ React Runtimeï¼‰

SDK æ˜ç¡®è§„å®šæ¸²æŸ“æµç¨‹ï¼š

```
setState()
â†’ è§¦å‘ onStateChange()
â†’ render()
â†’ æ‰§è¡Œ useEffect()
```

å¹¶é˜»æ­¢åœ¨ useEffect ä¸­å†æ¬¡ setStateï¼ˆé¿å…æ— é™å¾ªç¯ï¼‰ï¼š

```ts
if (this.isDispatching) {
  throw new Error('do not setState in useEffect')
}
```

è¿™å°±æ˜¯â€œå—æ§æ¸²æŸ“æ¨¡å‹â€ã€‚

---

## 3. æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 3.1 â€œçŠ¶æ€é©±åŠ¨æ¸²æŸ“â€

æ‰€æœ‰ UI æ›´æ–°éƒ½æ¥è‡ªä¸¤ç§è¾“å…¥ï¼š

* stateï¼šæ¸¸æˆè‡ªå·±çš„å†…éƒ¨çŠ¶æ€
* propsï¼šå®¿ä¸»ç«¯ä¼ æ¥çš„å¤–éƒ¨å‚æ•°

SDK ä¿è¯ï¼š

* ä¸ç›´æ¥æ“ä½œ DOMï¼ˆé¿å… iframe å·®å¼‚é—®é¢˜ï¼‰
* è®©å¼€å‘è€…åªå…³å¿ƒ state â†’ render()

ç®€åŒ–äº†æ¸¸æˆé€»è¾‘ã€‚

---

### 3.2 â€œHost / Client è§£è€¦é€šä¿¡â€

å®¿ä¸»ç«¯ä¸çŸ¥é“æ¸¸æˆå†…éƒ¨ç»“æ„ï¼Œä½†é€šè¿‡äº‹ä»¶å³å¯æ§åˆ¶æ¸¸æˆã€‚

æ¸¸æˆä¹Ÿä¸çŸ¥é“å®¿ä¸»ç«¯è¿è¡Œåœ¨å“ªï¼ˆPCã€iPadã€å°ç¨‹åºï¼‰ï¼Œä½†é€šè¿‡äº‹ä»¶å°±èƒ½ä¸å®¿ä¸»äº¤äº’ã€‚

**åè®®åŒ– â†’ è§£è€¦ â†’ ä½æˆæœ¬ç»´æŠ¤**

---

### 3.3 â€œå¯è§‚å¯Ÿã€å‰¯ä½œç”¨éš”ç¦»â€

SDK å†…éƒ¨æ¨¡æ‹Ÿä¸€ä¸ªç®€åŒ–ç‰ˆ hooksï¼š

```ts
useEffect(callback, deps)
```

ä½œç”¨ï¼š

* æ•°æ®å˜åŒ–æ‰æ‰§è¡Œå‰¯ä½œç”¨
* è‡ªåŠ¨æ‰§è¡Œæ¸…ç†å‡½æ•°
* å­˜å‚¨ä¾èµ–æ•°ç»„ dep â†’ diff

æ¯” React æ›´å°ï¼Œä½†å¯¹å°æ¸¸æˆé€»è¾‘å·²ç»è¶³å¤Ÿã€‚

---

## 4. useEffect å®ç°æœºåˆ¶è§£æ

### æ•´ä½“æµç¨‹

1. è®°å½• depsï¼š`effectDeps`
2. æ£€æŸ¥æ˜¯å¦å˜åŒ–
3. å¦‚å˜åŒ–ï¼Œåˆ™æ‰§è¡Œ cleanup()
4. æ‰§è¡Œ callback()
5. ä¿å­˜ cleanup å›è°ƒ
6. æ¯æ¬¡æ¸²æŸ“å‰ effectIndex é‡ç½®ä¸º 0

æ„å‘³ç€ render å†…éƒ¨è°ƒç”¨ useEffect çš„é¡ºåºå¿…é¡»ç¨³å®šï¼ˆå’Œ React ä¸€æ ·ï¼‰ã€‚

---

## 5. ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾

```
å®¿ä¸»ä¼ å…¥ props/state
        â†“
äº‹ä»¶è§¦å‘ pullProps / pullState
        â†“
props/state setter
        â†“
onStateChange()
        â†“
render()
        â†“
useEffect()
        â†“
ï¼ˆæ¸¸æˆå†…éƒ¨ç”»é¢æ›´æ–°ï¼‰
```

æ¸¸æˆå†…éƒ¨æ¯ä¸€æ¬¡æ›´æ–°éƒ½éµå¾ªè¿™æ¡é“¾è·¯ï¼Œæ‰€æœ‰è¡Œä¸ºéƒ½æœ‰æºå¤´ï¼Œå¯è®°å½•ã€å¯è°ƒè¯•ã€å¯å›æ”¾ã€‚

---

## 6. API è¯´æ˜

### 6.1 çŠ¶æ€ç›¸å…³

| API               | æè¿°                    |
| ----------------- | --------------------- |
| setState(partial) | åˆå¹¶å†…éƒ¨ stateï¼Œå¹¶é€šçŸ¥å®¿ä¸»      |
| state getter      | è·å–å†…éƒ¨ stateï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºé»˜è®¤å€¼ï¼‰ |
| state setter      | è®¾ç½®å®Œæ•´ stateï¼Œå¹¶è§¦å‘æ¸²æŸ“      |

---

### 6.2 å±æ€§ props

props ç”±å®¿ä¸»é©±åŠ¨ï¼š

```ts
client.on('pullProps', props => { this.props = props })
```

æ¸¸æˆä¸å¯ç›´æ¥ä¿®æ”¹ propsï¼Œåªèƒ½è¯·æ±‚ï¼š

```ts
setProps({ ... })
```

å®¿ä¸»å†å†³å®šæ˜¯å¦æ¥å—ï¼ˆå•å‘æ•°æ®æµï¼‰ã€‚

---

### 6.3 å‰¯ä½œç”¨ useEffect

ä¸ React ç±»ä¼¼ï¼Œç”¨äºï¼š

* ç›‘å¬ props/state å˜åŒ–
* æ³¨å†Œäº‹ä»¶
* æ‰§è¡ŒåŠ¨ç”»
* ç»‘å®šå¤–éƒ¨èµ„æº

---

### 6.4 å®¿ä¸»èƒ½åŠ›å°è£…

#### é™éŸ³

```ts
onMute(cb)
```

#### è¯­éŸ³æµ‹è¯„

```ts
beginSpeechEvaluation(content, options?)
stopSpeakingTest()
```

å¹¶æ¥å—å®¿ä¸»è¿”å›ï¼š

```ts
onbeginSpeechEvaluation
onStopSpeakingTest
ononSpeechEvaluationError
```

#### ç¼–è¾‘æ¨¡å¼

```ts
this.isEdit = true/false
```

---

## 7. init() æ³¨å†Œæœºåˆ¶

```ts
static init() {
  window.CourseGameSdk = {
    getGameClient: () => window.__CREATE_GAME_INSTANCE__
  }
}
```

ä½¿å¤–éƒ¨ä»»ä½•ç«¯éƒ½å¯ä»¥ï¼š

```js
window.CourseGameSdk.getGameClient()
```

ä» iframe å†…æ‹¿åˆ°å½“å‰æ¸¸æˆå®ä¾‹ï¼Œå®ç°è·¨ iframe çš„â€œå”¯ä¸€å®ä¾‹è®¿é—®â€ã€‚

---

## 8. ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

### ğŸ‘ 8.1 æ¯” React/Vue æ›´è½»

å°æ¸¸æˆæ— éœ€å®Œæ•´æ¡†æ¶ï¼Œä»…éœ€ï¼š

* çŠ¶æ€
* æ¸²æŸ“å‘¨æœŸ
* å‰¯ä½œç”¨
* é€šä¿¡

SDK å°±æ˜¯åªä¿ç•™å¿…è¦éƒ¨åˆ†çš„â€œReact Runtimeâ€ã€‚

---

### ğŸ‘ 8.2 å¼ºåˆ¶æ‰€æœ‰å˜åŒ–éƒ½æœ‰æ¥æºï¼ˆå¯è¿½è¸ªï¼‰

é“¾è·¯ï¼š

```
setState â†’ onStateChange â†’ render â†’ useEffect
```

ä»»ä½• UI é—®é¢˜éƒ½èƒ½å®šä½åˆ° state æµç¨‹ï¼Œæ— â€œé‡ç”Ÿé€»è¾‘â€ã€‚

---

### ğŸ‘ 8.3 è·¨ç«¯ä¸€è‡´æ€§

å„å¹³å°è¡¨ç°ä¸€è‡´ï¼Œå› ä¸ºï¼š

* æ²¡æœ‰ç›´æ¥ DOM æ“ä½œ
* ç”¨äº‹ä»¶åè®®æ¡¥æ¥å®¿ä¸»
* ç”Ÿå‘½å‘¨æœŸå¯æ§

---

### ğŸ‘ 8.4 æ–¹ä¾¿ç¼–è¾‘å™¨æ¥å…¥

ç¼–è¾‘å™¨å¯ä»¥éšæ—¶æ›´æ”¹ props/stateï¼Œè§¦å‘æ¸¸æˆå³æ—¶åˆ·æ–°ã€‚

---

### ğŸ‘ 8.5 æ¸¸æˆé€»è¾‘ä¸ä¸å¹³å°ç»‘å®š

æ¸¸æˆä»£ç ä¸éœ€è¦çŸ¥é“è¿è¡Œåœ¨ï¼š

* Web ç«¯
* ç¼–è¾‘å™¨
* App å†…åµŒå¼•æ“
* å°ç¨‹åº

åªéœ€å’Œ SDK äº¤äº’ã€‚

---

## 9. å…¸å‹ä½¿ç”¨æ–¹å¼ï¼ˆç¤ºä¾‹ï¼‰

æ¸¸æˆé€»è¾‘ï¼š

```ts
const client = new CourseGameClient()

client.getDefaultState = () => ({
  score: 0,
})

client.render = () => {
  const { score } = client.state

  client.useEffect(() => {
    console.log('score changed!', score)
  }, [score])
}
```

å®¿ä¸»å‘é€æ•°æ®ï¼š

```js
game.emit('pullState', { score: 10 })
```

æ¸¸æˆè¯·æ±‚å®¿ä¸»ï¼š

```js
client.setState({ score: client.state.score + 1 })
```

---

# æ€»ç»“ï¼ˆä¸€å¥è¯ï¼‰

`CourseGameClient` æ˜¯ä¸€ä¸ªï¼š

ğŸ‘‰ **è½»é‡çº§ React-like æ¸²æŸ“å¼•æ“ + æ¸¸æˆäº‹ä»¶åè®®å±‚ + å®¿ä¸»èƒ½åŠ›å°è£…å±‚**

å®ƒè®©æ¸¸æˆå…·æœ‰ç»Ÿä¸€ã€å¯æ§ã€è·¨ç«¯ä¸€è‡´çš„è¿è¡Œæ—¶ã€‚

---


---
title: å¼‚æ­¥ç«æ€å¤„ç†
tags:
  - promise vue
---



# ğŸ§© å¼‚æ­¥é™æ€å¤„ç†
### æ–‡æ¡£è¯´æ˜ï¼šå¤„ç† Tab å¼‚æ­¥æ•°æ®é”™ä¹±çš„æ–¹æ³•

#### é—®é¢˜èƒŒæ™¯
åœ¨ Tab åˆ‡æ¢åœºæ™¯ä¸­ï¼Œå½“ç”¨æˆ·å¿«é€Ÿåˆ‡æ¢ Tab æ—¶ï¼Œå¼‚æ­¥è¯·æ±‚çš„è¿”å›é¡ºåºå¯èƒ½ä¸æ“ä½œé¡ºåºä¸ä¸€è‡´ï¼Œå¯¼è‡´å†…å®¹æ˜¾ç¤ºé”™ä¹±ã€‚ä¾‹å¦‚ï¼šå…ˆç‚¹å‡» Tab 1ï¼Œå†å¿«é€Ÿåˆ‡æ¢åˆ° Tab 2ï¼ŒTab 1 çš„è¯·æ±‚å¯èƒ½æ™šäº Tab 2 è¿”å›ï¼Œæœ€ç»ˆé”™è¯¯åœ°æ˜¾ç¤º Tab 1 çš„å†…å®¹ã€‚

## âœ… ä¸¢å¼ƒè¿‡æœŸçš„è¯·æ±‚

#### å½“å‰è§£å†³æ–¹æ¡ˆ
é€šè¿‡ **æ¸…ç†ä¸Šä¸€ä¸ªå¼‚æ­¥è¯·æ±‚** çš„æ–¹å¼ï¼Œç¡®ä¿åªæœ‰æœ€åä¸€æ¬¡ Tab ç‚¹å‡»çš„è¯·æ±‚ç”Ÿæ•ˆã€‚æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š

---

#### 1. å®ç°æ€è·¯
- **å¼‚æ­¥è¯·æ±‚æ ‡è®°**ï¼šä¸ºæ¯ä¸ª Tab ç‚¹å‡»äº‹ä»¶ç”Ÿæˆå”¯ä¸€çš„æ ‡è®°ï¼ˆé€šè¿‡é—­åŒ…éš”ç¦»ï¼‰ã€‚
- **æ¸…ç†æœºåˆ¶**ï¼šæ¯æ¬¡å‘èµ·æ–°è¯·æ±‚å‰ï¼Œæ‰§è¡Œæ¸…ç†å‡½æ•°ï¼Œå°†ä¸Šä¸€ä¸ªè¯·æ±‚æ ‡è®°ä¸ºâ€œæ— æ•ˆâ€ã€‚
- **æ¡ä»¶æ¸²æŸ“**ï¼šè¯·æ±‚å®Œæˆåï¼Œæ£€æŸ¥å½“å‰æ ‡è®°æ˜¯å¦æœ‰æ•ˆï¼Œä»…æœ‰æ•ˆæ—¶æ›´æ–°å†…å®¹ã€‚

#### 2. ä»£ç å®ç°
```javascript
let cleanupQueue = []; // å­˜å‚¨æ¸…ç†å‡½æ•°çš„é˜Ÿåˆ—

tabs.forEach(tab => {
  tab.addEventListener("click", async () => {
    // 1. æ¸…ç†ä¸Šä¸€ä¸ªè¯·æ±‚
    while (cleanupQueue.length > 0) {
      const cleanup = cleanupQueue.shift();
      cleanup(); // æ‰§è¡Œæ¸…ç†å‡½æ•°ï¼Œæ ‡è®°æ—§è¯·æ±‚ä¸ºæ— æ•ˆ
    }

    // 2. æ›´æ–° Tab æ ·å¼å’Œå½“å‰æ ‡è¯†
    currentTab = tab.dataset.tab;
    tabs.forEach(t => t.classList.remove("active"));
    tab.classList.add("active");

    // 3. ç”Ÿæˆå½“å‰è¯·æ±‚çš„å”¯ä¸€æ ‡è®°
    let isValid = true;
    cleanupQueue.push(() => {
      isValid = false; // æ ‡è®°å½“å‰è¯·æ±‚ä¸ºæ— æ•ˆ
    });

    // 4. å‘èµ·å¼‚æ­¥è¯·æ±‚
    content.textContent = `æ­£åœ¨åŠ è½½ Tab ${currentTab}...`;
    const data = await simulateAsyncRequest(currentTab);

    // 5. æ ¹æ®æ ‡è®°åˆ¤æ–­æ˜¯å¦æ¸²æŸ“
    if (isValid) {
      content.textContent = data;
    }
  });
});
```

#### 3. å…³é”®é€»è¾‘è¯´æ˜
| æ­¥éª¤               | è¯´æ˜                                                                 |
|--------------------|--------------------------------------------------------------------|
| **æ¸…ç†ä¸Šä¸€ä¸ªè¯·æ±‚**   | é€šè¿‡é˜Ÿåˆ—æ‰§è¡Œæ¸…ç†å‡½æ•°ï¼Œå°†ä¹‹å‰çš„è¯·æ±‚æ ‡è®°ä¸ºæ— æ•ˆï¼Œé˜»æ­¢å…¶æ›´æ–°å†…å®¹ã€‚               |
| **ç”Ÿæˆå”¯ä¸€æ ‡è®°**     | æ¯ä¸ªè¯·æ±‚çš„ `isValid` å˜é‡é€šè¿‡é—­åŒ…éš”ç¦»ï¼Œç¡®ä¿æ¸…ç†åªå½±å“ç›®æ ‡è¯·æ±‚ã€‚             |
| **æ¡ä»¶æ¸²æŸ“**         | è¯·æ±‚è¿”å›åæ£€æŸ¥ `isValid`ï¼Œä»…æœ‰æ•ˆè¯·æ±‚æ›´æ–° UIï¼Œé¿å…æ•°æ®é”™ä¹±ã€‚                 |

---

#### 4. æ–¹æ¡ˆä¼˜ç¼ºç‚¹
**ä¼˜ç‚¹**ï¼š
- å®ç°ç®€å•ï¼Œæ— éœ€å¤æ‚çš„çŠ¶æ€ç®¡ç†ã€‚
- é€šè¿‡é—­åŒ…éš”ç¦»æ ‡è®°ï¼Œé€»è¾‘æ¸…æ™°ã€‚

**ç¼ºç‚¹**ï¼š
- æ— æ³•çœŸæ­£**ä¸­æ­¢**å·²å‘é€çš„å¼‚æ­¥è¯·æ±‚ï¼ˆå¦‚ `fetch`ï¼‰ï¼Œä»…æ ‡è®°æ— æ•ˆã€‚
- å¦‚æœè¯·æ±‚è€—æ—¶å·®å¼‚å¤§ï¼Œå¯èƒ½ä»ä¼šå ç”¨èµ„æºã€‚

---

## âœ… axios å–æ¶ˆè¯·æ±‚

### 1. å®šä¹‰è¯·æ±‚å–æ¶ˆæ§åˆ¶å™¨

```ts
// cancelManager.tsï¼ˆå¯å…±ç”¨ï¼‰
import axios from 'axios';

const cancelMap = new Map<string, AbortController>();

export function cancelRequest(key: string) {
  const controller = cancelMap.get(key)
  if (controller) {
    controller.abort(); // å–æ¶ˆè¯·æ±‚
    cancelMap.delete(key);
  }
}

export function createCancelableRequest(key: string) {
  cancelRequest(key); // å¦‚æœå·²å­˜åœ¨è¯¥è¯·æ±‚ï¼Œå…ˆå–æ¶ˆ

  const controller = new AbortController();
  cancelMap.set(key, controller);

  return controller.signal; // ä¼ ç»™ axios
}
```

---

### 2. ä½¿ç”¨å–æ¶ˆæ§åˆ¶å™¨å‘é€è¯·æ±‚

```ts
import axios from 'axios';
import { createCancelableRequest } from './cancelManager';

function fetchTabData(tabKey: string) {
  const signal = createCancelableRequest(tabKey);

  return axios.get('/api/tab-data', {
    params: { tab: tabKey },
    signal
  });
}
```

---

### 3. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

```ts
<template>
  <div>
    <button @click="switchTab('A')">Tab A</button>
    <button @click="switchTab('B')">Tab B</button>

    <div v-if="loading">åŠ è½½ä¸­...</div>
    <pre>{{ data }}</pre>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import { fetchTabData } from './api';

const data = ref(null);
const loading = ref(false);
const currentTab = ref('');

async function switchTab(tabKey) {
  currentTab.value = tabKey;
  loading.value = true;
  data.value = null;

  try {
    const res = await fetchTabData(tabKey);
    data.value = res.data;
  } catch (err) {
    if (err.code === 'ERR_CANCELED') {
      console.log(`è¯·æ±‚è¢«å–æ¶ˆï¼š${tabKey}`);
    } else {
      console.error('è¯·æ±‚å‡ºé”™ï¼š', err);
    }
  } finally {
    loading.value = false;
  }
}
</script>
```

---

## âœ… æ•ˆæœè¯´æ˜

* å½“ä½ å¿«é€Ÿåˆ‡æ¢ Tabï¼ˆå¦‚ A â†’ B â†’ Cï¼‰ï¼š

  * å‰ä¸€ä¸ªè¯·æ±‚ï¼ˆAã€Bï¼‰ä¼šè¢«å–æ¶ˆ
  * åªä¿ç•™å½“å‰ Tabï¼ˆCï¼‰çš„è¯·æ±‚å’Œæ•°æ®
* é¿å…å› è¯·æ±‚æ™šåˆ°é€ æˆçš„æ•°æ®é”™ä¹±é—®é¢˜ âœ…

---

## âœ… å°ç»“

| æ–¹æ¡ˆ                        | ä¼˜ç‚¹                     | ç¼ºç‚¹         |
| ------------------------- | ---------------------- | ---------- |
| Axios CancelTokenï¼ˆæ—§ï¼‰      | axios v0.x è‡ªå¸¦ï¼Œä½†å·²å¼ƒç”¨     | ä¸å†æ¨è       |
| **`AbortController`ï¼ˆæ¨èï¼‰** | æ ‡å‡† APIï¼Œaxiosã€fetch éƒ½æ”¯æŒ | éœ€è¦è‡ªå·±ç»´æŠ¤å–æ¶ˆé€»è¾‘ |

---
### Axios CancelTokenï¼ˆæ—§ï¼‰  

```js
const CancelToken = axios.CancelToken; 
const source = CancelToken.source();  
   axios.get('/user/12345', {   
       cancelToken: source.token 
   }).catch(function(thrown) {   
       if (axios.isCancel(thrown)) {     
       console.log('Request canceled', thrown.message);   
       } else {     
         // å¤„ç†é”™è¯¯  
       } 
   });
   axios.get('/user/123456', {   
       cancelToken: source.token 
   })
   
   axios.post('/user/12345', {   
    name: 'new name' 
   }, {   
    cancelToken: source.token 
   })  
 // å–æ¶ˆè¯·æ±‚ï¼ˆmessage å‚æ•°æ˜¯å¯é€‰çš„ï¼‰ 
source.cancel('Operation canceled by the user.');
```

---
title: è™šæ‹Ÿæ»šåŠ¨
tags:
   - è™šæ‹Ÿæ»šåŠ¨
---



## âœ… å®ç°ç›®æ ‡

* æ¸²æŸ“è¶…å¤§åˆ—è¡¨æ•°æ®ï¼ˆå¦‚ 1 ä¸‡æ¡ï¼‰
* å®é™… DOM ä¸­åªæ¸²æŸ“**å¯è§†åŒºåŸŸ + ç¼“å†²åŒº**çš„æ¡ç›®
* åŠ¨æ€è®¡ç®—å®¹å™¨é«˜åº¦ï¼Œä½¿æ»šåŠ¨æ¡æ­£ç¡®å·¥ä½œ

---

## ğŸ§± è™šæ‹Ÿæ»šåŠ¨ï¼ˆä¸å®šé«˜ï¼‰å®ç°æ­¥éª¤ç®€è¦æ€»ç»“ï¼š

---

1. **è®¾ç½®æ»šåŠ¨å®¹å™¨**
   åˆ›å»ºä¸€ä¸ªå¸¦æœ‰å›ºå®šé«˜åº¦å’Œ `overflow: auto` çš„å®¹å™¨ï¼Œä½œä¸ºæ»šåŠ¨åŒºåŸŸã€‚

2. **åˆ›å»ºå ä½å®¹å™¨æ’‘å¼€æ»šåŠ¨æ¡**
   ä½¿ç”¨ä¸€ä¸ªç©ºç™½å ä½å…ƒç´ ï¼ˆå¦‚ `<div style="height: xxxpx">`ï¼‰æ’‘å‡ºæ•´ä¸ªåˆ—è¡¨çš„é«˜åº¦ï¼Œè®©æ»šåŠ¨æ¡å‡ºç°ã€‚

3. **åˆå§‹åŒ–æ¸²æŸ“æ•°æ®ç»“æ„**
   å°†æ•°æ®é¡¹è½¬æ¢ä¸ºåŒ…å« `top`ã€`bottom`ã€`height` ç­‰ä¿¡æ¯çš„ `positions` æ•°ç»„ï¼Œåˆå§‹æ—¶é«˜åº¦å¯ä»¥è®¾ä¸ºé»˜è®¤å€¼ã€‚

4. **è®¡ç®—å¹¶æ¸²æŸ“å¯è§†åŒºåŸŸçš„æ•°æ®**
   æ ¹æ®å½“å‰æ»šåŠ¨ä½ç½®ï¼Œåªæ¸²æŸ“ä» `startIndex` åˆ° `endIndex` èŒƒå›´å†…çš„æ•°æ®ï¼Œæå‡æ€§èƒ½ã€‚

5. **æ»šåŠ¨æ—¶æ›´æ–°å¯è§†åŒºèŒƒå›´**
   ç›‘å¬ `scrollTop`ï¼Œç»“åˆäºŒåˆ†æŸ¥æ‰¾å¿«é€Ÿå®šä½ç¬¬ä¸€ä¸ªå¯è§†é¡¹çš„ç´¢å¼•ï¼Œæ›´æ–° `startIndex` å’Œ `endIndex`ï¼Œè§¦å‘æ¸²æŸ“ã€‚

6. **DOM æ›´æ–°åä¿®æ­£å®é™…é«˜åº¦å’Œä½ç½®**
   ä½¿ç”¨ `getBoundingClientRect()` æˆ– `offsetHeight` è·å–çœŸå®æ¸²æŸ“é«˜åº¦ï¼Œæ›´æ–°å¯¹åº”é¡¹çš„ `height`ã€`bottom`ï¼Œå¹¶ä»å˜åŠ¨é¡¹å¼€å§‹å‘åé€’æ¨ä¿®æ­£åç»­é¡¹çš„ä½ç½®ã€‚



---

## âœ… ä»£ç 


```vue

<script>
// VirtualList.vue
export default {
  props: {
  items: Array,     // åŸå§‹æ•°æ®åˆ—è¡¨
  size: Number,     // æ¯ä¸ª item çš„é»˜è®¤é«˜åº¦ï¼ˆä»…ç”¨äºåˆå§‹åŒ–ï¼‰
  remain: Number,   // å¯è§†åŒºåŸŸæ¸²æŸ“çš„ item æ•°é‡
  variable: Boolean // æ˜¯å¦æ”¯æŒé«˜åº¦ä¸å›ºå®š
},
  
  data() {
    return {
      start: 0,     // å¯è§†åŒºåŸŸå¼€å§‹çš„ index
    end: null,    // å¯è§†åŒºåŸŸç»“æŸçš„ index
    offset: 0     // å¯è§†åŒºåŸŸæ¸²æŸ“çš„èµ·å§‹åç§»é‡ï¼Œç”¨äº transform
    };
  },
  computed: {
    //ä¸ºæ¯ä¸ª item æ·»åŠ ä¸€ä¸ª index å±æ€§ï¼Œæ–¹ä¾¿åç»­å¤„ç†ã€‚
    formatData(){
      return this.items.map((item,index)=>({...item,index}))
    },  
    // start å’Œ end å†åŠ å‡é¢„åŠ è½½çš„ item æ•°é‡ï¼Œæå‡æ»šåŠ¨ä½“éªŒã€‚ åªæ¸²æŸ“è¿™éƒ¨åˆ†å…ƒç´ ã€‚
    visibleData() {
      let start = this.start - this.prevCount;
      let end = this.end + this.nextCount;
      return this.formatData.slice(start, end);
    },
    //å†³å®šå‰åå¤šæ¸²æŸ“å‡ ä¸ªå…ƒç´ ä½œä¸ºç¼“å­˜ï¼Œé¿å…æ»šåŠ¨é—ªçƒã€‚
    prevCount() {
      return Math.min(this.start, this.remain);
    },
    nextCount() {
      return Math.min(this.items.length - this.end, this.remain);
    }
  },
  mounted() {
    // 1.è®¾ç½®viewPrortçš„é«˜åº¦ æ§åˆ¶è§†å£å±•ç¤º remain ä¸ª item
    this.$refs.viewport.style.height = this.remain * this.size + "px";
   // è®¾ç½® scrollBar çš„é«˜åº¦ï¼šåˆ¶é€ ä¸€ä¸ªæ€»é«˜åº¦ï¼Œè®©é¡µé¢å‡ºç°æ»šåŠ¨æ¡
    this.$refs.scrollBar.style.height = this.items.length * this.size + "px";
   // åˆå§‹åŒ–æ¸²æŸ“èŒƒå›´
    this.end = this.start + this.remain;
    // å¦‚æœæ˜¯ä¸å®šé«˜ï¼Œåˆå§‹åŒ–æ‰€æœ‰ item çš„ä½ç½®è®°å½•
    if (this.variable) {
      this.initPosition();
    }
  },
  /**
   * æ›´æ–°æ‰€æœ‰æ¸²æŸ“ä¸­çš„ DOM å…ƒç´ çš„å®é™…é«˜åº¦

å’Œä¹‹å‰è®°å½•çš„é«˜åº¦æ¯”è¾ƒï¼Œå¦‚æœæœ‰å˜åŒ–åˆ™æ›´æ–° positions

é‡æ–°è®¡ç®—æ‰€æœ‰åç»­ item çš„ top/bottom å€¼ï¼ˆç´¯åŠ å¼ï¼‰

æ›´æ–°æ»šåŠ¨æ¡æ€»é«˜åº¦

æ›´æ–°åç§» offset
   */
  updated(){
    console.log('updated');
      // è·å–çœŸå®å…ƒç´ çš„ä½ç½® æ›´æ–°topå’Œbottom;
     this.$nextTick(()=>{
        let nodes = this.$refs.items;
        if(!(nodes && nodes.length >0)){
            return 
        }
        nodes.forEach(node=>{ 
            let rect = node.getBoundingClientRect();
            let height = rect.height;
            let index = +node.getAttribute('vid');
            let oldHeight = this.positions[index].height;
            let val = oldHeight - height;
            console.log(val);
            if(val){ 
                // å…ˆæ›´æ–°è‡ªå·±
                this.positions[index].bottom = this.positions[index].bottom - val;
                this.positions[index].height = height;
                for(let i = index+1;i<this.positions.length;i++){
                    this.positions[i].top = this.positions[i-1].bottom;
                    this.positions[i].bottom = this.positions[i].bottom - val;
                }
            }
        })
        this.$refs.scrollBar.style.height = this.positions[this.positions.length-1].bottom +'px';
        // this.offset = this.positions[this.start - this.prevCount]? this.positions[this.start - this.prevCount].top : 0;
     });
  },
  methods: {
    // åˆå§‹åŒ–æ¯ä¸ª item çš„ top å’Œ bottom ä½ç½®
    initPosition() {
      // åˆå§‹åŒ–ä½ç½®
      this.positions = this.items.map((item, index) => ({
        index,
        height: this.size,
        top: index * this.size, //å½“å‰å…ƒç´ è·ç¦»æ•´ä¸ªåˆ—è¡¨é¡¶éƒ¨çš„åƒç´ å€¼ï¼ˆåç§»ï¼‰  ç¬¬0é¡¹æ˜¯ 0Ã—30=0ï¼Œç¬¬3é¡¹æ˜¯ 3Ã—30=90
        bottom: (index + 1) * this.size // å½“å‰å…ƒç´ åº•éƒ¨è·ç¦»åˆ—è¡¨é¡¶éƒ¨çš„åƒç´ å€¼ï¼ˆ= top + heightï¼‰ ç¬¬0é¡¹æ˜¯ (0+1)Ã—30=30ï¼Œç¬¬3é¡¹æ˜¯ (3+1)Ã—30=120
      }));
    },
    //äºŒåˆ†æŸ¥æ‰¾ï¼šæ ¹æ®æ»šåŠ¨é«˜åº¦å¿«é€Ÿæ‰¾å‡ºâ€œç¬¬ä¸€ä¸ªå¯è§†å…ƒç´ çš„ indexâ€
    // é€šè¿‡äºŒåˆ†æŸ¥æ‰¾ scrollTop æ‰€å¯¹åº”çš„å…ƒç´ ï¼ˆå³åˆ¤æ–­ scrollTop è½åœ¨å“ªä¸ª top ~ bottom åŒºé—´å†…ï¼‰ï¼Œé¿å…å…¨é‡éå†ï¼Œæé«˜æ€§èƒ½ã€‚
    getStartIndex(value) {
      //åœ¨å½“å‰ä½ç½®ä¸­é—´æ‰¾ä¸€ä¸ª middleIndexï¼Œè·å–å…¶ bottom å€¼ï¼ˆå³è¯¥ item åº•éƒ¨çš„åƒç´ ä½ç½®ï¼‰ã€‚
      let positions = this.positions;
      let start = 0;
      let end = this.positions.length;
      let temp = null;
      while (start < end) {
        let middleIndex = parseInt((start + end) / 2); // å‘ä¸‹å–æ•´
        let middleValue = this.positions[middleIndex].bottom;
        if (value == middleValue) {
        //å¦‚æœæ»šåŠ¨ä½ç½®åˆšå¥½ç­‰äºæŸä¸ª item çš„ bottomï¼Œå°±è¿”å›ä¸‹ä¸€ä¸ª item çš„ç´¢å¼•ï¼ˆå› ä¸ºä¸‹ä¸€ä¸ªæ‰æ˜¯è¦å¼€å§‹æ¸²æŸ“çš„ï¼‰ã€‚
          return middleIndex + 1;
        } else if (middleValue < value) {
          // å¦‚æœå½“å‰ middle çš„ bottom å°äºæ»šåŠ¨ä½ç½®ï¼Œè¯´æ˜å½“å‰é¡¹åœ¨æ»šåŠ¨åŒºåŸŸçš„ä¸Šæ–¹ï¼Œåº”è¯¥å¾€å³è¾¹æŸ¥æ‰¾ã€‚
           start = middleIndex + 1;
        } else if (middleValue > value) {
          // å¦‚æœ middle çš„ bottom å¤§äºæ»šåŠ¨ä½ç½®ï¼Œè¯´æ˜å½“å‰ item è¿˜åœ¨å±å¹•å†…ï¼Œè¦å¾€å·¦ç»§ç»­æ‰¾æ›´å‰çš„ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„é¡¹ã€‚

         // è®°å½•æœ€å°çš„æ»¡è¶³æ¡ä»¶çš„ç´¢å¼•
          temp = Math.min(temp ?? Infinity, middleIndex);
          end = middleIndex - 1;
        }
      }
      return temp;
    },
    /**
     * ä¸¤ç§æƒ…å†µï¼š
å›ºå®šé«˜åº¦ï¼šç”¨ scrollTop / size å¿«é€Ÿç®—å‡ºèµ·å§‹ index

ä¸å®šé«˜åº¦ï¼šç”¨ getStartIndex() ç»“åˆ positions æ˜ å°„æ‰¾å‡ºèµ·å§‹ index

ç„¶åæ ¹æ®èµ·å§‹é¡¹ï¼Œè®¾ç½® offsetï¼Œä¹Ÿå°±æ˜¯æ¸²æŸ“å†…å®¹åŒºåŸŸåº”å‘ä¸‹å¹³ç§»çš„è·ç¦»ã€‚
     */
    handleScroll() {
      let scrollTop = this.$refs.viewport.scrollTop;
      if (this.variable) {
        // ç®—å‡ºå¼€å§‹çš„ä½ç½®
        this.start = this.getStartIndex(scrollTop);
        this.end = this.start + this.remain;
        this.offset = this.positions[this.start - this.prevCount]? this.positions[this.start - this.prevCount].top : 0;
        // ç®—å‡ºç»“å°¾ä½ç½®
        // è®¾ç½®åç§»é‡
      } else {
        // è®¡ç®—å¼€å§‹
        this.start = Math.floor(scrollTop / this.size);
        // è®¡ç®—ç»“æŸ
        this.end = this.start + this.remain;
        // è®¡ç®—åç§»é‡
        this.offset =
          scrollTop - (scrollTop % this.size) - this.prevCount * this.size;
      }
    }
  }
};
</script>

<template>
  <div class="viewport" ref="viewport" @scroll="handleScroll">
      <!-- å¯æ»šåŠ¨å®¹å™¨ -->
    <div class="scrollBar" ref="scrollBar"></div>
      <!-- å ä½é«˜åº¦ï¼Œä½¿å®¹å™¨å‡ºç°æ»šåŠ¨æ¡ -->
    <div class="scroll-list" :style="{transform:`translate3d(0,${offset}px,0)`}">
      <!-- çœŸæ­£æ¸²æŸ“çš„å¯è§†å…ƒç´ ï¼Œå‘ä¸‹å¹³ç§» offset ä½ç½® -->
      <div v-for="(item,index) in visibleData" :key="item.id" :vid="item.index" ref="items">
        <slot :item="item"></slot>
      </div>
    </div>
  </div>
</template>
<style lang="stylus">
.viewport {
  overflow-y: scroll;
  position: relative;
}

.scroll-list {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
}
</style>
```
```vue

<script>
// Item.vue
export default {
    props:{
        item:{}
    },
  
}
</script>
<template>
    <div class="item" style="padding:40px 0; font-size:25px">
       {{item.id}} {{item.value}}
    </div>
</template>
<style lang="stylus">
.item{
    border 1px solid red
}
</style>
```

### ç»„ä»¶ä½¿ç”¨
```vue
<script>
// ç»„ä»¶ä½¿ç”¨
import VirtualList from './components/virtual-list';
import Item from './components/item';
import Mock from 'mockjs'
let items = [];
for(let i = 0 ; i<1000 ; i++){
  items.push({id:i,value:Mock.Random.sentence()});
}
export default {
  name: 'App',
  data(){
    return {items}
  },
  components:{
    VirtualList,
    Item
  }
}
</script>


<template>
  <div id="app">
    <virtual-list
      :size="80"
      :remain="8"
      :items="items"
      :variable="true"
    >
      <Item 
        slot-scope="{item}" 
        :item="item"/>
    </virtual-list>
  </div>
</template>

<style lang="stylus">
*{
  margin 0; 
  padding:0;
  box-sizing: border-box;
}
</style>

```